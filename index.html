<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweden Finance</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #ffd700; --bg: #1a1a1a; --card: #2d2d2d; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-bottom: 80px; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--gold); }
        .info-bar { background: #b8860b33; padding: 12px; font-size: 13px; border-radius: 8px; margin-bottom: 20px; color: var(--gold); text-align: center; border: 1px solid var(--gold); }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; box-sizing: border-box; font-size: 16px; font-family: inherit; }
        textarea { min-height: 100px; resize: vertical; }
        button { width: 100%; padding: 14px; background: var(--gold); border: none; border-radius: 8px; font-weight: bold; font-size: 16px; color: #000; cursor: pointer; margin-top: 5px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .hidden { display: none !important; }
        .bond-item { border-bottom: 1px solid #444; padding: 10px 0; }
        .nav-btn { background: #333; color: white; margin-top: 10px; }
        .market-item { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
        .withdraw-btn { background: #28a745; color: white; margin-top: 10px; font-size: 14px; padding: 10px; }
        .deposit-btn { background: #17a2b8; color: white; margin-top: 5px; }
        .complaint-btn { background: #ff6b6b; color: white; margin-top: 5px; }
        .lock-badge { font-size: 11px; color: #ff4444; margin-top: 8px; display: block; }
        .sync-indicator { font-size: 11px; opacity: 0.6; text-align: center; margin-top: 10px; }
        .social-links { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; border-top: 2px solid var(--gold); padding: 12px 15px; display: flex; justify-content: center; gap: 20px; z-index: 1000; }
        .social-links a { color: var(--gold); font-size: 24px; text-decoration: none; transition: transform 0.2s; }
        .social-links a:hover { transform: scale(1.2); }
    </style>
</head>
<body>
    <div id="loader" style="text-align: center; padding-top: 50px;">‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–µ–µ—Å—Ç—Ä—É...</div>

    <div id="reg-screen" class="hidden">
        <h2 style="color: var(--gold)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <input type="text" id="reg-nick" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º">
        <input type="text" id="reg-role" placeholder="–í–∞—à–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç—å">
        <button onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </div>

    <div id="main-screen" class="hidden">
        <div class="info-bar" id="info-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div style="margin-bottom: 20px;">
            <h2 id="u-nick" style="margin:0; color: var(--gold)">–ù–∏–∫–Ω–µ–π–º</h2>
            <div id="u-role" style="opacity: 0.7; font-size: 14px;">–î–æ–ª–∂–Ω–æ—Å—Ç—å</div>
        </div>
        <div class="card">
            <small>–ë–ê–õ–ê–ù–°</small>
            <h1 id="u-bal">0.00 GOLD</h1>
        </div>
        <h3>–û–ø–µ—Ä–∞—Ü–∏–∏</h3>
        <button onclick="showPage('deposit')" class="deposit-btn">üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
        <button onclick="showPage('transfer')">üí∏ –ü–µ—Ä–µ–≤–æ–¥ –∏–≥—Ä–æ–∫—É</button>
        <button onclick="showPage('withdraw')">üè¶ –°–Ω—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤</button>
        <button onclick="showPage('bonds')" style="background: #daa520">üìà –ú–æ–∏ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</button>
        <button onclick="showPage('market')" style="background: #0055aa; color: white;">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
        <button onclick="showPage('complaint')" class="complaint-btn" id="complaint-btn">üìã –ñ–∞–ª–æ–±–∞</button>
        <button onclick="window.open('https://docs.google.com/document/d/1CtUNPBjuuo-twrqvRVmm0YhRizTwmP5xTh8G9xNwmzU/edit?tab=t.0', '_blank')" style="background: #444; color: white; border: 1px solid var(--gold);">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</button>
        
        <div class="sync-indicator" id="sync-status">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>
        <button onclick="tg.close()" class="nav-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="deposit-screen" class="hidden">
        <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h3>
        <div style="background: #2d2d2d; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ff6b6b;">
            <p style="margin: 0; font-size: 14px; line-height: 1.6;">
                ‚ö†Ô∏è <strong>–í–ê–ñ–ù–û!</strong><br><br>
                –í—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ø–æ–ª–Ω–∏—Ç—å –∫–∞–∑–Ω—É –Ω–∞—Ü–∏–∏ –Ω–∞ —Å—É–º–º—É, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç—å –Ω–∞ —Å–≤–æ–π —Å—á—ë—Ç.<br><br>
                üì∏ –ü–æ—Å–ª–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –≤ Telegram: <strong>@Kolorli21</strong><br><br>
                üí∞ –í–≤–æ–¥–∏—Ç–µ —Å—É–º–º—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ!
            </p>
        </div>
        <input type="number" id="d-sum" placeholder="–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è" min="1" step="0.01">
        <button onclick="requestDeposit()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="transfer-screen" class="hidden">
        <h3>–ü–µ—Ä–µ–≤–æ–¥ GOLD</h3>
        <select id="t-id"></select>
        <input type="number" id="t-sum" placeholder="–°—É–º–º–∞">
        <button onclick="action('transfer')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="withdraw-screen" class="hidden">
        <h3>–°–Ω—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤</h3>
        <input type="number" id="w-sum" placeholder="–°—É–º–º–∞">
        <button onclick="action('withdraw')">–ó–∞–ø—Ä–æ—Å–∏—Ç—å</button>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="bonds-screen" class="hidden">
        <h3>–í–∞—à–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h3>
        <div id="bonds-list"></div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="market-screen" class="hidden">
        <h3>–ú–∞–≥–∞–∑–∏–Ω –æ–±–ª–∏–≥–∞—Ü–∏–π</h3>
        <div id="market-list"></div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="complaint-screen" class="hidden">
        <h3>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h3>
        <p style="font-size: 14px; opacity: 0.8;">–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –∂–∞–ª–æ–±—É. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –µ—ë –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</p>
        <textarea id="complaint-text" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∂–∞–ª–æ–±—É –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É..." maxlength="500"></textarea>
        <div style="font-size: 12px; opacity: 0.6; text-align: right;" id="char-count">0/500</div>
        <button onclick="action('complaint')" id="submit-complaint-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É</button>
        <div id="complaint-timer" style="font-size: 13px; color: #ff6b6b; text-align: center; margin-top: 10px;"></div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ -->
    <div class="social-links">
        <a href="https://discord.gg/your-discord" target="_blank" title="Discord">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
            </svg>
        </a>
        <a href="https://t.me/your-channel" target="_blank" title="Telegram">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 0 0-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
            </svg>
        </a>
        <a href="https://youtube.com/@your-channel" target="_blank" title="YouTube">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
        </a>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const params = new URLSearchParams(window.location.search);
        
        // –£–ö–ê–ñ–ò –°–í–û–ô RENDER URL
        const RENDER_URL = "https://swedfixk.onrender.com";
        
        let syncInterval = null;
        let canComplain = true;

        function showPage(page) {
            ['reg', 'main', 'transfer', 'withdraw', 'bonds', 'market', 'complaint', 'deposit'].forEach(p => {
                const el = document.getElementById(p + '-screen');
                if (el) el.classList.add('hidden');
            });
            document.getElementById(page + '-screen').classList.remove('hidden');
        }

        function register() {
            const nick = document.getElementById('reg-nick').value;
            const role = document.getElementById('reg-role').value;
            if(!nick || !role) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");
            tg.sendData(JSON.stringify({action: 'register', nick, role}));
        }

        function requestDeposit() {
            const amount = parseFloat(document.getElementById('d-sum').value);
            if(!amount || amount <= 0) {
                alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!");
                return;
            }
            
            const confirmed = confirm(`–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ${amount.toFixed(2)} GOLD?\n\n–ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∑–Ω—ã –≤ @Kolorli21!`);
            if(confirmed) {
                tg.sendData(JSON.stringify({
                    action: 'deposit_request',
                    amount: amount,
                    nick: decodeURIComponent(params.get('nick') || "User")
                }));
            }
        }

        function action(type) {
            const data = { action: type, nick: decodeURIComponent(params.get('nick') || "User") };
            
            if(type === 'transfer') {
                data.target_id = document.getElementById('t-id').value;
                data.amount = parseFloat(document.getElementById('t-sum').value);
                if(!data.target_id) {
                    alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è!");
                    return;
                }
                if(!data.amount || data.amount <= 0) return alert("–û—à–∏–±–∫–∞ —Å—É–º–º—ã!");
            } else if(type === 'withdraw') {
                data.amount = parseFloat(document.getElementById('w-sum').value);
                if(!data.amount || data.amount <= 0) return alert("–û—à–∏–±–∫–∞ —Å—É–º–º—ã!");
            } else if(type === 'complaint') {
                data.complaint = document.getElementById('complaint-text').value.trim();
                if(!data.complaint) return alert("–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –∂–∞–ª–æ–±—ã!");
                if(!canComplain) return alert("–í—ã —Å–º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É –ø–æ–∑–∂–µ!");
            }
            
            tg.sendData(JSON.stringify(data));
        }

        function buyBond(id, minPrice) {
            const amount = parseFloat(prompt(`–°—É–º–º–∞ (–º–∏–Ω ${minPrice}):`, minPrice));
            if(amount >= minPrice) {
                tg.sendData(JSON.stringify({action: 'buy_bond', bond_id: parseInt(id), amount: amount}));
            }
        }

        function sellBond(id, val) {
            if(confirm(`–ó–∞–±—Ä–∞—Ç—å ${val.toFixed(2)} GOLD?`)) {
                tg.sendData(JSON.stringify({action: 'sell_bond', bond_id: parseInt(id)}));
            }
        }

        // –°—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –∂–∞–ª–æ–±—ã
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('complaint-text');
            const counter = document.getElementById('char-count');
            if(textarea && counter) {
                textarea.addEventListener('input', function() {
                    counter.innerText = `${this.value.length}/500`;
                });
            }
        });

        // –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–•
        async function refreshData() {
            const uid = params.get('tg_id');
            if (!uid) return;
            
            try {
                const response = await fetch(`${RENDER_URL}/api/get_user_data?uid=${uid}`);
                if (!response.ok) throw new Error('Network error');
                
                const data = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                document.getElementById('u-bal').innerText = data.balance.toFixed(2) + " GOLD";
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
                if (data.info) {
                    document.getElementById('info-text').innerText = data.info;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ–±–ª–∏–≥–∞—Ü–∏–π
                const bList = document.getElementById('bonds-list');
                const bonds = data.bonds || [];
                bList.innerHTML = bonds.length ? "" : "<p style='text-align:center; opacity:0.5;'>–ù–µ—Ç –≤–ª–æ–∂–µ–Ω–∏–π</p>";
                bonds.forEach(b => {
                    const btn = b.can_withdraw 
                        ? `<button class="withdraw-btn" onclick="sellBond(${b.id}, ${b.current_value})">üí∞ –°–Ω—è—Ç—å ${b.current_value.toFixed(2)} GOLD</button>`
                        : `<span class="lock-badge">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π</span>`;
                    bList.innerHTML += `<div class="card"><b>${b.name}</b><br>üíµ –ù–∞ —Å—á–µ—Ç—É: ${b.current_value.toFixed(2)} GOLD<br>üìÖ –î–∞—Ç–∞: ${b.date}<br>${btn}</div>`;
                });
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã
                canComplain = data.can_complain;
                const complaintBtn = document.getElementById('complaint-btn');
                const submitBtn = document.getElementById('submit-complaint-btn');
                const timerDiv = document.getElementById('complaint-timer');
                
                if(!canComplain) {
                    if(complaintBtn) complaintBtn.disabled = true;
                    if(submitBtn) submitBtn.disabled = true;
                    if(timerDiv) timerDiv.innerText = "‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ 12 —á–∞—Å–æ–≤ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –∂–∞–ª–æ–±–æ–π";
                } else {
                    if(complaintBtn) complaintBtn.disabled = false;
                    if(submitBtn) submitBtn.disabled = false;
                    if(timerDiv) timerDiv.innerText = "";
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                const now = new Date();
                document.getElementById('sync-status').innerText = `‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${now.toLocaleTimeString('ru-RU')}`;
                
            } catch (err) {
                console.warn("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:", err);
                document.getElementById('sync-status').innerText = `‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏`;
            }
        }

        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
        async function refreshUsers() {
            try {
                const response = await fetch(`${RENDER_URL}/api/get_users`);
                if (!response.ok) return;
                
                const users = await response.json();
                const sel = document.getElementById('t-id');
                const currentValue = sel.value;
                
                sel.innerHTML = '<option value="" disabled selected>–ö–æ–º—É –ø–µ—Ä–µ–≤–æ–¥–∏–º?</option>';
                users.forEach(u => {
                    if(u.id !== params.get('tg_id')) {
                        sel.innerHTML += `<option value="${u.id}">${u.nick}</option>`;
                    }
                });
                
                if (currentValue) sel.value = currentValue;
            } catch (err) {
                console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", err);
            }
        }

        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ú–ê–ì–ê–ó–ò–ù–ê
        async function refreshMarket() {
            try {
                const response = await fetch(`${RENDER_URL}/api/get_market`);
                if (!response.ok) return;
                
                const market = await response.json();
                const mList = document.getElementById('market-list');
                mList.innerHTML = market.length ? "" : "<p style='text-align:center; opacity:0.5;'>–ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç</p>";
                market.forEach(m => {
                    mList.innerHTML += `<div class="market-item"><b>${m.name}</b><br>üìä –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: ${m.rate}%<br>üí∞ –ú–∏–Ω. —Å—É–º–º–∞: ${m.price} GOLD<br><button onclick="buyBond(${m.id}, ${m.price})">–ö—É–ø–∏—Ç—å</button></div>`;
                });
            } catch (err) {
                console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞:", err);
            }
        }

        window.onload = () => {
            document.getElementById('loader').classList.add('hidden');
            const exists = params.get('exists') === 'true';
            
            if (!exists) {
                showPage('reg');
            } else {
                showPage('main');
                document.getElementById('u-nick').innerText = decodeURIComponent(params.get('nick') || "User");
                document.getElementById('u-role').innerText = decodeURIComponent(params.get('role') || "");
                document.getElementById('u-bal').innerText = (params.get('bal') || "0.00") + " GOLD";

                // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                refreshData();
                refreshUsers();
                refreshMarket();

                // –ó–ê–ü–£–°–ö –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–Ø –ö–ê–ñ–î–´–ï 7 –°–ï–ö–£–ù–î
                syncInterval = setInterval(() => {
                    refreshData();
                }, 7000);
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –º–∞–≥–∞–∑–∏–Ω–∞ —Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥
                setInterval(() => {
                    refreshUsers();
                    refreshMarket();
                }, 30000);
            }
        };
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.onbeforeunload = () => {
            if (syncInterval) clearInterval(syncInterval);
        };
    </script>
</body>
</html>
