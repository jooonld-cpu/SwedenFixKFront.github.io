<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweden Finance</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #ffd700; --bg: #1a1a1a; --card: #2d2d2d; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--gold); }
        .info-bar { background: #b8860b33; padding: 12px; font-size: 13px; border-radius: 8px; margin-bottom: 20px; color: var(--gold); text-align: center; border: 1px solid var(--gold); }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; box-sizing: border-box; font-size: 16px; font-family: inherit; }
        textarea { min-height: 100px; resize: vertical; }
        button { width: 100%; padding: 14px; background: var(--gold); border: none; border-radius: 8px; font-weight: bold; font-size: 16px; color: #000; cursor: pointer; margin-top: 5px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .hidden { display: none !important; }
        .bond-item { border-bottom: 1px solid #444; padding: 10px 0; }
        .nav-btn { background: #333; color: white; margin-top: 10px; }
        .market-item { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
        .withdraw-btn { background: #28a745; color: white; margin-top: 10px; font-size: 14px; padding: 10px; }
        .complaint-btn { background: #ff6b6b; color: white; margin-top: 5px; }
        .lock-badge { font-size: 11px; color: #ff4444; margin-top: 8px; display: block; }
        .sync-indicator { font-size: 11px; opacity: 0.6; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="loader" style="text-align: center; padding-top: 50px;">‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–µ–µ—Å—Ç—Ä—É...</div>

    <div id="reg-screen" class="hidden">
        <h2 style="color: var(--gold)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <input type="text" id="reg-nick" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º">
        <input type="text" id="reg-role" placeholder="–í–∞—à–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç—å">
        <button onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </div>

    <div id="main-screen" class="hidden">
        <div class="info-bar" id="info-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div style="margin-bottom: 20px;">
            <h2 id="u-nick" style="margin:0; color: var(--gold)">–ù–∏–∫–Ω–µ–π–º</h2>
            <div id="u-role" style="opacity: 0.7; font-size: 14px;">–î–æ–ª–∂–Ω–æ—Å—Ç—å</div>
        </div>
        <div class="card">
            <small>–ë–ê–õ–ê–ù–°</small>
            <h1 id="u-bal">0.00 GOLD</h1>
        </div>
        <h3>–û–ø–µ—Ä–∞—Ü–∏–∏</h3>
        <button onclick="showPage('transfer')">üí∏ –ü–µ—Ä–µ–≤–æ–¥ –∏–≥—Ä–æ–∫—É</button>
        <button onclick="showPage('withdraw')">üè¶ –°–Ω—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤</button>
        <button onclick="showPage('bonds')" style="background: #daa520">üìà –ú–æ–∏ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</button>
        <button onclick="showPage('market')" style="background: #0055aa; color: white;">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
        <button onclick="showPage('complaint')" class="complaint-btn" id="complaint-btn">üìã –ñ–∞–ª–æ–±–∞</button>
        <button onclick="window.open('https://t.me/SwedenFix_News', '_blank')" style="background: #444; color: white; border: 1px solid var(--gold);">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</button>
        
        <div class="sync-indicator" id="sync-status">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>
        <button onclick="tg.close()" class="nav-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="transfer-screen" class="hidden">
        <h3>–ü–µ—Ä–µ–≤–æ–¥ GOLD</h3>
        <select id="t-id"></select>
        <input type="number" id="t-sum" placeholder="–°—É–º–º–∞">
        <button onclick="action('transfer')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="withdraw-screen" class="hidden">
        <h3>–°–Ω—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤</h3>
        <input type="number" id="w-sum" placeholder="–°—É–º–º–∞">
        <button onclick="action('withdraw')">–ó–∞–ø—Ä–æ—Å–∏—Ç—å</button>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="bonds-screen" class="hidden">
        <h3>–í–∞—à–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h3>
        <div id="bonds-list"></div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="market-screen" class="hidden">
        <h3>–ú–∞–≥–∞–∑–∏–Ω –æ–±–ª–∏–≥–∞—Ü–∏–π</h3>
        <div id="market-list"></div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="complaint-screen" class="hidden">
        <h3>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h3>
        <p style="font-size: 14px; opacity: 0.8;">–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –∂–∞–ª–æ–±—É. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –µ—ë –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</p>
        <textarea id="complaint-text" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∂–∞–ª–æ–±—É –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É..." maxlength="500"></textarea>
        <div style="font-size: 12px; opacity: 0.6; text-align: right;" id="char-count">0/500</div>
        <button onclick="action('complaint')" id="submit-complaint-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É</button>
        <div id="complaint-timer" style="font-size: 13px; color: #ff6b6b; text-align: center; margin-top: 10px;"></div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const params = new URLSearchParams(window.location.search);
        
        // –£–ö–ê–ñ–ò –°–í–û–ô RENDER URL
        const RENDER_URL = "https://swedfixk.onrender.com";
        
        let syncInterval = null;
        let canComplain = true;

        function showPage(page) {
            ['reg', 'main', 'transfer', 'withdraw', 'bonds', 'market', 'complaint'].forEach(p => {
                const el = document.getElementById(p + '-screen');
                if (el) el.classList.add('hidden');
            });
            document.getElementById(page + '-screen').classList.remove('hidden');
        }

        function register() {
            const nick = document.getElementById('reg-nick').value;
            const role = document.getElementById('reg-role').value;
            if(!nick || !role) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");
            tg.sendData(JSON.stringify({action: 'register', nick, role}));
        }

        function action(type) {
            const data = { action: type, nick: decodeURIComponent(params.get('nick') || "User") };
            
            if(type === 'transfer') {
                data.target_id = document.getElementById('t-id').value;
                data.amount = parseFloat(document.getElementById('t-sum').value);
                if(!data.target_id) {
                    alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è!");
                    return;
                }
                if(!data.amount || data.amount <= 0) return alert("–û—à–∏–±–∫–∞ —Å—É–º–º—ã!");
            } else if(type === 'withdraw') {
                data.amount = parseFloat(document.getElementById('w-sum').value);
                if(!data.amount || data.amount <= 0) return alert("–û—à–∏–±–∫–∞ —Å—É–º–º—ã!");
            } else if(type === 'complaint') {
                data.complaint = document.getElementById('complaint-text').value.trim();
                if(!data.complaint) return alert("–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –∂–∞–ª–æ–±—ã!");
                if(!canComplain) return alert("–í—ã —Å–º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É –ø–æ–∑–∂–µ!");
            }
            
            tg.sendData(JSON.stringify(data));
        }

        function buyBond(id, minPrice) {
            const amount = parseFloat(prompt(`–°—É–º–º–∞ (–º–∏–Ω ${minPrice}):`, minPrice));
            if(amount >= minPrice) {
                tg.sendData(JSON.stringify({action: 'buy_bond', bond_id: parseInt(id), amount: amount}));
            }
        }

        function sellBond(id, val) {
            if(confirm(`–ó–∞–±—Ä–∞—Ç—å ${val.toFixed(2)} GOLD?`)) {
                tg.sendData(JSON.stringify({action: 'sell_bond', bond_id: parseInt(id)}));
            }
        }

        // –°—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –∂–∞–ª–æ–±—ã
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('complaint-text');
            const counter = document.getElementById('char-count');
            if(textarea && counter) {
                textarea.addEventListener('input', function() {
                    counter.innerText = `${this.value.length}/500`;
                });
            }
        });

        // –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–•
        async function refreshData() {
            const uid = params.get('tg_id');
            if (!uid) return;
            
            try {
                const response = await fetch(`${RENDER_URL}/api/get_user_data?uid=${uid}`);
                if (!response.ok) throw new Error('Network error');
                
                const data = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                document.getElementById('u-bal').innerText = data.balance.toFixed(2) + " GOLD";
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
                if (data.info) {
                    document.getElementById('info-text').innerText = data.info;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ–±–ª–∏–≥–∞—Ü–∏–π
                const bList = document.getElementById('bonds-list');
                const bonds = data.bonds || [];
                bList.innerHTML = bonds.length ? "" : "<p style='text-align:center; opacity:0.5;'>–ù–µ—Ç –≤–ª–æ–∂–µ–Ω–∏–π</p>";
                bonds.forEach(b => {
                    const btn = b.can_withdraw 
                        ? `<button class="withdraw-btn" onclick="sellBond(${b.id}, ${b.current_value})">üí∞ –°–Ω—è—Ç—å ${b.current_value.toFixed(2)} GOLD</button>`
                        : `<span class="lock-badge">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π</span>`;
                    bList.innerHTML += `<div class="card"><b>${b.name}</b><br>üíµ –ù–∞ —Å—á–µ—Ç—É: ${b.current_value.toFixed(2)} GOLD<br>üìÖ –î–∞—Ç–∞: ${b.date}<br>${btn}</div>`;
                });
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã
                canComplain = data.can_complain;
                const complaintBtn = document.getElementById('complaint-btn');
                const submitBtn = document.getElementById('submit-complaint-btn');
                const timerDiv = document.getElementById('complaint-timer');
                
                if(!canComplain) {
                    if(complaintBtn) complaintBtn.disabled = true;
                    if(submitBtn) submitBtn.disabled = true;
                    if(timerDiv) timerDiv.innerText = "‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ 12 —á–∞—Å–æ–≤ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –∂–∞–ª–æ–±–æ–π";
                } else {
                    if(complaintBtn) complaintBtn.disabled = false;
                    if(submitBtn) submitBtn.disabled = false;
                    if(timerDiv) timerDiv.innerText = "";
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                const now = new Date();
                document.getElementById('sync-status').innerText = `‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${now.toLocaleTimeString('ru-RU')}`;
                
            } catch (err) {
                console.warn("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:", err);
                document.getElementById('sync-status').innerText = `‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏`;
            }
        }

        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
        async function refreshUsers() {
            try {
                const response = await fetch(`${RENDER_URL}/api/get_users`);
                if (!response.ok) return;
                
                const users = await response.json();
                const sel = document.getElementById('t-id');
                const currentValue = sel.value;
                
                sel.innerHTML = '<option value="" disabled selected>–ö–æ–º—É –ø–µ—Ä–µ–≤–æ–¥–∏–º?</option>';
                users.forEach(u => {
                    if(u.id !== params.get('tg_id')) {
                        sel.innerHTML += `<option value="${u.id}">${u.nick}</option>`;
                    }
                });
                
                if (currentValue) sel.value = currentValue;
            } catch (err) {
                console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", err);
            }
        }

        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ú–ê–ì–ê–ó–ò–ù–ê
        async function refreshMarket() {
            try {
                const response = await fetch(`${RENDER_URL}/api/get_market`);
                if (!response.ok) return;
                
                const market = await response.json();
                const mList = document.getElementById('market-list');
                mList.innerHTML = market.length ? "" : "<p style='text-align:center; opacity:0.5;'>–ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç</p>";
                market.forEach(m => {
                    mList.innerHTML += `<div class="market-item"><b>${m.name}</b><br>üìä –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: ${m.rate}%<br>üí∞ –ú–∏–Ω. —Å—É–º–º–∞: ${m.price} GOLD<br><button onclick="buyBond(${m.id}, ${m.price})">–ö—É–ø–∏—Ç—å</button></div>`;
                });
            } catch (err) {
                console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞:", err);
            }
        }

        window.onload = () => {
            document.getElementById('loader').classList.add('hidden');
            const exists = params.get('exists') === 'true';
            
            if (!exists) {
                showPage('reg');
            } else {
                showPage('main');
                document.getElementById('u-nick').innerText = decodeURIComponent(params.get('nick') || "User");
                document.getElementById('u-role').innerText = decodeURIComponent(params.get('role') || "");
                document.getElementById('u-bal').innerText = (params.get('bal') || "0.00") + " GOLD";

                // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                refreshData();
                refreshUsers();
                refreshMarket();

                // –ó–ê–ü–£–°–ö –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–Ø –ö–ê–ñ–î–´–ï 7 –°–ï–ö–£–ù–î
                syncInterval = setInterval(() => {
                    refreshData();
                }, 7000);
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –º–∞–≥–∞–∑–∏–Ω–∞ —Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥
                setInterval(() => {
                    refreshUsers();
                    refreshMarket();
                }, 30000);
            }
        };
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.onbeforeunload = () => {
            if (syncInterval) clearInterval(syncInterval);
        };
    </script>
</body>
</html>
