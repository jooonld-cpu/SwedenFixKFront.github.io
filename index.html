<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; padding: 15px; }
        .card { background: #2d2d2d; padding: 20px; border-radius: 15px; margin: 10px 0; border: 1px solid #ffd700; }
        button { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 8px; background: #ffd700; color: black; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }
        input, select { width: 95%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; background: #333; color: white; }
        .gold { color: #ffd700; font-size: 1.5em; font-weight: bold; }
        label { display: block; text-align: left; margin-left: 5px; color: #aaa; font-size: 0.9em; }
    </style>
</head>
<body>

    <div id="reg-screen" class="hidden">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <input type="text" id="nick" placeholder="–í–∞—à –ù–∏–∫">
        <input type="text" id="role" placeholder="–í–∞—à–∞ –î–æ–ª–∂–Ω–æ—Å—Ç—å">
        <button onclick="register()">–í—Å—Ç—É–ø–∏—Ç—å –≤ –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ</button>
    </div>

    <div id="main-menu" class="hidden">
        <h2>–ö–∞–±–∏–Ω–µ—Ç –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω–∞</h2>
        <div class="card">
            <p><span id="user-info"></span></p>
        </div>
        <button onclick="showFinance()">üè¶ –ú–æ–∏ –°—á–µ—Ç–∞ (–ë–∞–Ω–∫–∏)</button>
        <button onclick="window.open('https://docs.google.com/document/d/1CtUNPBjuuo-twrqvRVmm0YhRizTwmP5xTh8G9xNwmzU/edit', '_blank')">üìú –ó–∞–∫–æ–Ω—ã</button>
    </div>

    <div id="finance-screen" class="hidden">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞–º–∏</h2>
        
        <div class="card">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫:</label>
            <select id="bank-select" onchange="updateBalanceDisplay()"></select>
            
            <p>–ë–∞–ª–∞–Ω—Å –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –±–∞–Ω–∫–µ:</p>
            <p class="gold"><span id="display-balance">0</span> GOLD</p>
        </div>

        <button onclick="showTransfer()">üí∏ –ü–µ—Ä–µ–≤–æ–¥</button>
        <button onclick="showWithdraw()">üì• –°–Ω—è—Ç–∏–µ</button>
        <button onclick="hideAll(); document.getElementById('main-menu').classList.remove('hidden')" style="background: #555; color: white;">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="transfer-page" class="hidden">
        <h2>–ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h2>
        <p id="transfer-bank-label" style="color:#ffd700"></p>
        <select id="user-select"></select>
        <input type="number" id="t-amount" placeholder="–°—É–º–º–∞">
        <button onclick="sendAction('transfer')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button onclick="showFinance()" style="background: #555; color: white;">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="withdraw-page" class="hidden">
        <h2>–°–Ω—è—Ç–∏–µ –Ω–∞–ª–∏—á–Ω—ã—Ö</h2>
        <p id="withdraw-bank-label" style="color:#ffd700"></p>
        <input type="number" id="w-amount" placeholder="–°—É–º–º–∞">
        <button onclick="sendAction('withdraw')" style="background: #e67e22; color: white;">–ó–∞–ø—Ä–æ—Å–∏—Ç—å</button>
        <button onclick="showFinance()" style="background: #555; color: white;">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const params = new URLSearchParams(window.location.search);

        // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
        const exists = params.get('exists');
        let accounts = []; 

        try {
            // –ß–∏—Ç–∞–µ–º JSON —Å–æ —Å—á–µ—Ç–∞–º–∏ –∏–∑ URL
            accounts = JSON.parse(params.get('accounts') || "[]");
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å—á–µ—Ç–æ–≤", e);
        }

        if (exists === 'true') {
            document.getElementById('main-menu').classList.remove('hidden');
            document.getElementById('user-info').innerText = params.get('nick') + " (" + params.get('role') + ")";
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –±–∞–Ω–∫–æ–≤
            const bankSelect = document.getElementById('bank-select');
            accounts.forEach(acc => {
                let opt = document.createElement('option');
                opt.value = acc.bank_id;
                opt.text = acc.bank_name;
                opt.dataset.balance = acc.balance; // –•—Ä–∞–Ω–∏–º –±–∞–ª–∞–Ω—Å –≤ –∞—Ç—Ä–∏–±—É—Ç–µ
                bankSelect.appendChild(opt);
            });

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —é–∑–µ—Ä–æ–≤
            const userSelect = document.getElementById('user-select');
            (params.get('users') || "").split(',').forEach(u => {
                if(u && u.includes(':')) {
                    let [id, name] = u.split(':');
                    let opt = document.createElement('option');
                    opt.value = id; opt.text = name;
                    userSelect.appendChild(opt);
                }
            });

        } else {
            document.getElementById('reg-screen').classList.remove('hidden');
        }

        function updateBalanceDisplay() {
            const select = document.getElementById('bank-select');
            const balance = select.options[select.selectedIndex].dataset.balance;
            const bankName = select.options[select.selectedIndex].text;
            
            document.getElementById('display-balance').innerText = balance;
            document.getElementById('transfer-bank-label').innerText = "–ë–∞–Ω–∫: " + bankName;
            document.getElementById('withdraw-bank-label').innerText = "–ë–∞–Ω–∫: " + bankName;
        }

        function showFinance() {
            if (accounts.length === 0) return alert("–£ –≤–∞—Å –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å—á–µ—Ç–æ–≤!");
            hideAll();
            document.getElementById('finance-screen').classList.remove('hidden');
            updateBalanceDisplay();
        }

        function showTransfer() { hideAll(); document.getElementById('transfer-page').classList.remove('hidden'); }
        function showWithdraw() { hideAll(); document.getElementById('withdraw-page').classList.remove('hidden'); }

        function hideAll() {
            ['reg-screen', 'main-menu', 'finance-screen', 'transfer-page', 'withdraw-page'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        function register() {
            const n = document.getElementById('nick').value;
            const r = document.getElementById('role').value;
            if(!n || !r) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");
            tg.sendData(JSON.stringify({ action: 'register', nick: n, role: r }));
        }

        function sendAction(act) {
            const bankId = parseInt(document.getElementById('bank-select').value);
            const amount = parseFloat(act === 'transfer' ? document.getElementById('t-amount').value : document.getElementById('w-amount').value);
            const target = document.getElementById('user-select').value;

            if(!amount || amount <= 0) return alert("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞");

            tg.sendData(JSON.stringify({
                action: act,
                bank_id: bankId,
                amount: amount,
                target_id: target || ""
            }));
            tg.close();
        }
    </script>
</body>
</html>
