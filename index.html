<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweden Finance</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --gold: #ffd700; 
            --gold-dark: #b8860b;
            --bg: #0f0f0f; 
            --card: rgba(45, 45, 45, 0.7); 
            --text: #ffffff;
            --accent: #0055aa;
        }

        body { 
            font-family: 'SF Pro Display', 'Segoe UI', Roboto, sans-serif; 
            background: radial-gradient(circle at top, #1a1a1a 0%, var(--bg) 100%);
            color: var(--text); 
            padding: 20px; 
            margin: 0; 
            padding-bottom: 100px;
            overflow-x: hidden;
        }

        /* --- –ê–Ω–∏–º–∞—Ü–∏–∏ --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseLogo { 0% { filter: drop-shadow(0 0 5px var(--gold)); } 50% { filter: drop-shadow(0 0 20px var(--gold)); } 100% { filter: drop-shadow(0 0 5px var(--gold)); } }
        @keyframes slide { from { transform: translateX(-100%); } to { transform: translateX(100%); } }

        /* --- –õ–æ–≥–æ—Ç–∏–ø --- */
        .header-section { text-align: center; margin-bottom: 25px; animation: fadeIn 0.8s ease-out; }
        .logo-container { width: 100px; height: 100px; margin: 0 auto 15px; position: relative; }
        .main-logo { width: 100%; height: 100%; object-fit: contain; animation: pulseLogo 3s infinite ease-in-out; }

        /* --- –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ --- */
        .card { 
            background: var(--card); 
            backdrop-filter: blur(10px);
            padding: 18px; 
            border-radius: 16px; 
            margin-bottom: 15px; 
            border: 1px solid rgba(255, 215, 0, 0.15);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            animation: fadeIn 0.5s ease-out;
        }

        .info-bar { 
            background: rgba(184, 134, 11, 0.15); 
            padding: 12px; 
            font-size: 13px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            color: var(--gold); 
            text-align: center; 
            border: 1px solid var(--gold);
            position: relative;
            overflow: hidden;
        }

        .info-bar::after {
            content: ""; position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,215,0,0.2), transparent);
            animation: slide 3s infinite;
        }

        h1, h2, h3 { color: var(--gold); margin: 5px 0; }
        .balance-card h1 { font-size: 32px; letter-spacing: 1px; text-shadow: 0 2px 10px rgba(255,215,0,0.3); }

        input, select, textarea { 
            width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; 
            border: 1px solid #333; background: rgba(0,0,0,0.4); color: #fff; 
            box-sizing: border-box; font-size: 16px;
        }

        button { 
            width: 100%; padding: 16px; background: linear-gradient(135deg, var(--gold), #b8860b); 
            border: none; border-radius: 12px; font-weight: bold; font-size: 16px; 
            color: #000; cursor: pointer; margin-top: 8px; transition: 0.2s;
        }

        button:active { transform: scale(0.97); }
        button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        .deposit-btn { background: linear-gradient(135deg, #17a2b8, #0b7a8b); color: white; }
        .complaint-btn { background: linear-gradient(135deg, #ff6b6b, #c0392b); color: white; }
        .nav-btn { background: #333; color: white; margin-top: 15px; }
        
        .market-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #444; }
        .lock-badge { color: #ff4444; font-size: 12px; display: block; margin-top: 10px; font-weight: bold; }
        .sync-indicator { font-size: 11px; opacity: 0.5; text-align: center; margin-top: 15px; }

        .hidden { display: none !important; }

        /* –°–æ—Ü—Å–µ—Ç–∏ */
        .social-links { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 215, 0, 0.3); 
            padding: 15px; display: flex; justify-content: center; gap: 25px; z-index: 1000; 
        }
        .social-links a { color: var(--gold); transition: 0.3s; }
        .social-links a:hover { transform: translateY(-3px); }
    </style>
</head>
<body>
    <div id="loader" style="text-align: center; padding-top: 50px; color: var(--gold);">‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–µ–µ—Å—Ç—Ä—É...</div>

    <div id="reg-screen" class="hidden">
        <div class="header-section">
            <div class="logo-container">
                <img src="logo.png" alt="Logo" class="main-logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2610/2610116.png'">
            </div>
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        </div>
        <div class="card">
            <input type="text" id="reg-nick" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º">
            <input type="text" id="reg-role" placeholder="–í–∞—à–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç—å">
            <button onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
    </div>

    <div id="main-screen" class="hidden">
        <div class="header-section">
            <div class="logo-container">
                <img src="logo.png" alt="Logo" class="main-logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2610/2610116.png'">
            </div>
            <div class="info-bar" id="info-text">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>
            <h2 id="u-nick" style="margin:0;">–ù–∏–∫–Ω–µ–π–º</h2>
            <div id="u-role" style="opacity: 0.6; font-size: 14px;">–î–æ–ª–∂–Ω–æ—Å—Ç—å</div>
        </div>

        <div class="card balance-card">
            <small style="color: var(--gold); font-weight: bold; opacity: 0.8;">–í–ê–® –ë–ê–õ–ê–ù–°</small>
            <h1 id="u-bal">0.00 GOLD</h1>
        </div>

        <h3>–û–ø–µ—Ä–∞—Ü–∏–∏</h3>
        <button onclick="showPage('deposit')" class="deposit-btn">üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
        <button onclick="showPage('transfer')">üí∏ –ü–µ—Ä–µ–≤–æ–¥ –∏–≥—Ä–æ–∫—É</button>
        <button onclick="showPage('withdraw')">üè¶ –°–Ω—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤</button>
        <button onclick="showPage('bonds')" style="background: #daa520; color: #000;">üìà –ú–æ–∏ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</button>
        <button onclick="showPage('market')" style="background: var(--accent); color: white;">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
        <button onclick="showPage('complaint')" class="complaint-btn" id="complaint-btn">üìã –ñ–∞–ª–æ–±–∞</button>
        <button onclick="window.open('https://docs.google.com/document/d/1CtUNPBjuuo-twrqvRVmm0YhRizTwmP5xTh8G9xNwmzU/edit?tab=t.0', '_blank')" style="background: #444; color: white; border: 1px solid var(--gold);">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</button>
        
        <div class="sync-indicator" id="sync-status">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>
        <button onclick="tg.close()" class="nav-btn">–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
    </div>

    <div id="deposit-screen" class="hidden">
        <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h3>
        <div class="card" style="border-left: 4px solid #ff6b6b; background: rgba(255, 107, 107, 0.05);">
            <p style="margin: 0; font-size: 14px; line-height: 1.6;">
                ‚ö†Ô∏è <strong>–í–ê–ñ–ù–û!</strong><br>
                –í—ã –¥–æ–ª–∂–Ω—ã —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –∫–∞–∑–Ω—É –Ω–∞—Ü–∏–∏. –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ: <strong>@Kolorli21</strong>
            </p>
        </div>
        <input type="number" id="d-sum" placeholder="–°—É–º–º–∞ GOLD" min="1">
        <button onclick="requestDeposit()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="transfer-screen" class="hidden">
        <h3>–ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h3>
        <div class="card">
            <select id="t-id"></select>
            <input type="number" id="t-sum" placeholder="–°—É–º–º–∞">
            <button onclick="action('transfer')">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
        </div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="withdraw-screen" class="hidden">
        <h3>–°–Ω—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤</h3>
        <div class="card">
            <input type="number" id="w-sum" placeholder="–°—É–º–º–∞">
            <button onclick="action('withdraw')">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É</button>
        </div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="bonds-screen" class="hidden">
        <h3>–í–∞—à–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h3>
        <div id="bonds-list"></div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="market-screen" class="hidden">
        <h3>–ú–∞–≥–∞–∑–∏–Ω –æ–±–ª–∏–≥–∞—Ü–∏–π</h3>
        <div id="market-list"></div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="complaint-screen" class="hidden">
        <h3>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h3>
        <div class="card">
            <textarea id="complaint-text" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É..." maxlength="500"></textarea>
            <div style="font-size: 12px; opacity: 0.6; text-align: right;" id="char-count">0/500</div>
            <button onclick="action('complaint')" id="submit-complaint-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <div id="complaint-timer" style="font-size: 13px; color: #ff6b6b; text-align: center; margin-top: 10px;"></div>
        </div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div class="social-links">
        <a href="https://discord.gg/EyR2t2rtPm" target="_blank">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/></svg>
        </a>
        <a href="https://t.me/c/3305558456/12" target="_blank">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 0 0-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/></svg>
        </a>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const params = new URLSearchParams(window.location.search);
        const RENDER_URL = "https://swedfixk.onrender.com";
        
        let syncInterval = null;
        let canComplain = true;

        function showPage(page) {
            ['reg', 'main', 'transfer', 'withdraw', 'bonds', 'market', 'complaint', 'deposit'].forEach(p => {
                const el = document.getElementById(p + '-screen');
                if (el) el.classList.add('hidden');
            });
            document.getElementById(page + '-screen').classList.remove('hidden');
        }

        function register() {
            const nick = document.getElementById('reg-nick').value;
            const role = document.getElementById('reg-role').value;
            if(!nick || !role) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");
            tg.sendData(JSON.stringify({action: 'register', nick, role}));
        }

        function requestDeposit() {
            const amount = parseFloat(document.getElementById('d-sum').value);
            if(!amount || amount <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!");
            
            const confirmed = confirm(`–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ${amount.toFixed(2)} GOLD?`);
            if(confirmed) {
                tg.sendData(JSON.stringify({
                    action: 'deposit_request',
                    amount: amount,
                    nick: decodeURIComponent(params.get('nick') || "User")
                }));
            }
        }

        function action(type) {
            const data = { action: type, nick: decodeURIComponent(params.get('nick') || "User") };
            
            if(type === 'transfer') {
                data.target_id = document.getElementById('t-id').value;
                data.amount = parseFloat(document.getElementById('t-sum').value);
                if(!data.target_id) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è!");
                if(!data.amount || data.amount <= 0) return alert("–û—à–∏–±–∫–∞ —Å—É–º–º—ã!");
            } else if(type === 'withdraw') {
                data.amount = parseFloat(document.getElementById('w-sum').value);
                if(!data.amount || data.amount <= 0) return alert("–û—à–∏–±–∫–∞ —Å—É–º–º—ã!");
            } else if(type === 'complaint') {
                data.complaint = document.getElementById('complaint-text').value.trim();
                if(!data.complaint) return alert("–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –∂–∞–ª–æ–±—ã!");
                if(!canComplain) return alert("–í—ã —Å–º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É –ø–æ–∑–∂–µ!");
            }
            tg.sendData(JSON.stringify(data));
        }

        function buyBond(id, minPrice) {
            const amount = parseFloat(prompt(`–°—É–º–º–∞ (–º–∏–Ω ${minPrice}):`, minPrice));
            if(amount >= minPrice) {
                tg.sendData(JSON.stringify({action: 'buy_bond', bond_id: parseInt(id), amount: amount}));
            }
        }

        function sellBond(id, val) {
            if(confirm(`–ó–∞–±—Ä–∞—Ç—å ${val.toFixed(2)} GOLD?`)) {
                tg.sendData(JSON.stringify({action: 'sell_bond', bond_id: parseInt(id)}));
            }
        }

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–∫–∞–∂–¥—ã–µ 7 —Å–µ–∫)
        async function refreshData() {
            const uid = params.get('tg_id');
            if (!uid) return;
            try {
                const response = await fetch(`${RENDER_URL}/api/get_user_data?uid=${uid}`);
                const data = await response.json();
                
                document.getElementById('u-bal').innerText = data.balance.toFixed(2) + " GOLD";
                if (data.info) document.getElementById('info-text').innerText = data.info;
                
                const bList = document.getElementById('bonds-list');
                const bonds = data.bonds || [];
                bList.innerHTML = bonds.length ? "" : "<p style='text-align:center; opacity:0.5;'>–ù–µ—Ç –≤–ª–æ–∂–µ–Ω–∏–π</p>";
                bonds.forEach(b => {
                    const btn = b.can_withdraw 
                        ? `<button onclick="sellBond(${b.id}, ${b.current_value})">üí∞ –°–Ω—è—Ç—å ${b.current_value.toFixed(2)}</button>`
                        : `<span class="lock-badge">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</span>`;
                    bList.innerHTML += `<div class="card"><b>${b.name}</b><br>üíµ –ù–∞ —Å—á–µ—Ç—É: ${b.current_value.toFixed(2)}<br>${btn}</div>`;
                });
                
                canComplain = data.can_complain;
                document.getElementById('complaint-btn').disabled = !canComplain;
                document.getElementById('submit-complaint-btn').disabled = !canComplain;
                document.getElementById('complaint-timer').innerText = canComplain ? "" : "‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ 12 —á–∞—Å–æ–≤";
                
                document.getElementById('sync-status').innerText = `‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${new Date().toLocaleTimeString()}`;
            } catch (err) {
                document.getElementById('sync-status').innerText = `‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏`;
            }
        }

        async function refreshUsers() {
            try {
                const response = await fetch(`${RENDER_URL}/api/get_users`);
                const users = await response.json();
                const sel = document.getElementById('t-id');
                const cur = sel.value;
                sel.innerHTML = '<option value="" disabled selected>–ö–æ–º—É –ø–µ—Ä–µ–≤–æ–¥–∏–º?</option>';
                users.forEach(u => {
                    if(u.id !== params.get('tg_id')) sel.innerHTML += `<option value="${u.id}">${u.nick}</option>`;
                });
                if (cur) sel.value = cur;
            } catch (err) {}
        }

        async function refreshMarket() {
            try {
                const response = await fetch(`${RENDER_URL}/api/get_market`);
                const market = await response.json();
                const mList = document.getElementById('market-list');
                mList.innerHTML = market.length ? "" : "<p style='text-align:center; opacity:0.5;'>–ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç</p>";
                market.forEach(m => {
                    mList.innerHTML += `<div class="market-item"><b>${m.name}</b><br>üìä –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: ${m.rate}%<br>üí∞ –û—Ç ${m.price} GOLD<br><button onclick="buyBond(${m.id}, ${m.price})">–ö—É–ø–∏—Ç—å</button></div>`;
                });
            } catch (err) {}
        }

        document.addEventListener('DOMContentLoaded', () => {
            const tx = document.getElementById('complaint-text');
            if(tx) tx.addEventListener('input', function() {
                document.getElementById('char-count').innerText = `${this.value.length}/500`;
            });
        });

        window.onload = () => {
            document.getElementById('loader').classList.add('hidden');
            const exists = params.get('exists') === 'true';
            if (!exists) {
                showPage('reg');
            } else {
                showPage('main');
                document.getElementById('u-nick').innerText = decodeURIComponent(params.get('nick') || "User");
                document.getElementById('u-role').innerText = decodeURIComponent(params.get('role') || "");
                document.getElementById('u-bal').innerText = (params.get('bal') || "0.00") + " GOLD";
                
                refreshData(); refreshUsers(); refreshMarket();
                syncInterval = setInterval(refreshData, 7000);
                setInterval(() => { refreshUsers(); refreshMarket(); }, 30000);
            }
        };

        window.onbeforeunload = () => { if (syncInterval) clearInterval(syncInterval); };
    </script>
</body>
</html>
