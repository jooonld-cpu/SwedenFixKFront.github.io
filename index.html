<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; padding: 15px; }
        .card { background: #2d2d2d; padding: 20px; border-radius: 15px; margin: 10px 0; border: 1px solid #ffd700; }
        button { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 8px; background: #ffd700; color: black; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }
        input { width: 90%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; background: #333; color: white; }
        .gold { color: #ffd700; font-size: 1.5em; font-weight: bold; }
        h2 { color: #ffd700; }
    </style>
</head>
<body>

    <div id="reg-screen" class="hidden">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –®–≤–µ—Ü–∏–∏</h2>
        <p>–í–∞—Å –Ω–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å:</p>
        <div class="card">
            <input type="text" id="nick" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ù–∏–∫">
            <input type="text" id="role" placeholder="–í–∞—à–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç—å/—Ä–æ–ª—å">
            <button onclick="register()" style="background: #28a745; color: white;">–ó–∞–Ω–µ—Å—Ç–∏ –≤ —Ä–µ–µ—Å—Ç—Ä</button>
        </div>
    </div>

    <div id="main-menu" class="hidden">
        <h2>–ï–¥–∏–Ω–∞—è —Å–ø—Ä–∞–≤–æ—á–Ω–∞—è –®–≤–µ—Ü–∏–∏</h2>
        <div class="card">
            <p><strong>–ù–∏–∫:</strong> <span id="user-nick"></span></p>
            <p><strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong> <span id="user-role"></span></p>
        </div>
        <button onclick="window.open('https://docs.google.com/document/d/1CtUNPBjuuo-twrqvRVmm0YhRizTwmP5xTh8G9xNwmzU/edit', '_blank')">üìú –ó–∞–∫–æ–Ω—ã</button>
        <button onclick="showFinance()">üí∞ –§–∏–Ω–∞–Ω—Å—ã (–ù–ë–®)</button>
    </div>

    <div id="finance-screen" class="hidden">
        <h2>–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫ –®–≤–µ—Ü–∏–∏</h2>
        <div class="card">
            <p>–ë–∞–ª–∞–Ω—Å:</p>
            <p class="gold"><span id="val-balance"></span> GOLD</p>
        </div>
        
        <div id="transfer-box">
            <p>–ü–µ—Ä–µ–≤–æ–¥ –∏–≥—Ä–æ–∫—É:</p>
            <select id="user-select" style="width: 95%; padding: 10px; margin-bottom: 10px; border-radius: 8px;"></select>
            <input type="number" id="amount-input" placeholder="–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞">
            <button onclick="sendTransfer()" style="background: #ffd700; color: black;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å GOLD</button>
        </div>
        
        <button onclick="location.reload()" style="background: #555; color: white; margin-top: 20px;">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const params = new URLSearchParams(window.location.search);
        const exists = params.get('exists');

        if (exists === 'true') {
            document.getElementById('main-menu').classList.remove('hidden');
            document.getElementById('user-nick').innerText = params.get('nick');
            document.getElementById('user-role').innerText = params.get('role');
            document.getElementById('val-balance').innerText = params.get('balance');
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const select = document.getElementById('user-select');
            const users = params.get('users') || "";
            users.split(',').forEach(u => {
                if(u) {
                    const [id, name] = u.split(':');
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.text = name;
                    select.appendChild(opt);
                }
            });
        } else {
            document.getElementById('reg-screen').classList.remove('hidden');
        }

        function register() {
            const n = document.getElementById('nick').value;
            const r = document.getElementById('role').value;
            if(!n || !r) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
            
            tg.sendData(JSON.stringify({ action: 'register', nick: n, role: r }));
            tg.close();
        }

        function showFinance() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('finance-screen').classList.remove('hidden');
        }

        function sendTransfer() {
            const target = document.getElementById('user-select').value;
            const amount = parseFloat(document.getElementById('amount-input').value);
            if(!target) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è!");
            if(amount <= 0) return alert("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞!");

            tg.sendData(JSON.stringify({ action: 'transfer', target_id: target, amount: amount }));
            tg.close();
        }
    </script>
</body>
</html>
