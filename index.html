<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweden Finance</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #ffd700; --bg: #1a1a1a; --card: #2d2d2d; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--gold); }
        .info-bar { background: #b8860b33; padding: 12px; font-size: 13px; border-radius: 8px; margin-bottom: 20px; color: var(--gold); text-align: center; border: 1px solid var(--gold); }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; background: var(--gold); border: none; border-radius: 8px; font-weight: bold; font-size: 16px; color: #000; cursor: pointer; margin-top: 5px; }
        .hidden { display: none !important; }
        .bond-item { border-bottom: 1px solid #444; padding: 10px 0; }
        .bond-item:last-child { border: none; }
        .nav-btn { background: #333; color: white; margin-top: 10px; }
        .market-item { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–Ω—è—Ç–∏—è */
        .withdraw-btn { background: #28a745; color: white; margin-top: 10px; font-size: 14px; padding: 10px; }
        .lock-badge { font-size: 11px; color: #ff4444; margin-top: 8px; display: block; }
    </style>
</head>
<body>
    <div id="loader" style="text-align: center; padding-top: 50px;">‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–µ–µ—Å—Ç—Ä—É –®–≤–µ—Ü–∏–∏...</div>

    <div id="reg-screen" class="hidden">
        <h2 style="color: var(--gold)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <p>–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∏–Ω–∞–Ω—Å–∞–º —Å–æ–∑–¥–∞–π—Ç–µ –∏–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å:</p>
        <input type="text" id="reg-nick" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º">
        <input type="text" id="reg-role" placeholder="–í–∞—à–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç—å">
        <button onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </div>

    <div id="main-screen" class="hidden">
        <div class="info-bar" id="info-text">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</div>
        
        <div style="margin-bottom: 20px;">
            <h2 id="u-nick" style="margin:0; color: var(--gold)">–ù–∏–∫–Ω–µ–π–º</h2>
            <div id="u-role" style="opacity: 0.7; font-size: 14px;">–î–æ–ª–∂–Ω–æ—Å—Ç—å</div>
        </div>

        <div class="card">
            <small style="text-transform: uppercase; color: var(--gold)">–í–∞—à –±–∞–ª–∞–Ω—Å</small>
            <h1 id="u-bal" style="margin: 10px 0 0 0;">0.00 GOLD</h1>
        </div>

        <h3>–û–ø–µ—Ä–∞—Ü–∏–∏</h3>
        <button onclick="showPage('transfer')">üí∏ –ü–µ—Ä–µ–≤–æ–¥ –∏–≥—Ä–æ–∫—É</button>
        <button onclick="showPage('withdraw')">üè¶ –°–Ω—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤</button>
        <button onclick="showPage('bonds')" style="background: #daa520">üìà –ú–æ–∏ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</button>
        <button onclick="showPage('market')" style="background: #0055aa; color: white;">üõí –ú–∞–≥–∞–∑–∏–Ω –æ–±–ª–∏–≥–∞—Ü–∏–π</button>
        
        <button onclick="tg.close()" class="nav-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="transfer-screen" class="hidden">
        <h3>–ü–µ—Ä–µ–≤–æ–¥ GOLD</h3>
        <p style="font-size: 14px; opacity: 0.8;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</p>
        <select id="t-id">
            <option value="" disabled selected>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</option>
        </select>
        <input type="number" id="t-sum" placeholder="–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞">
        <button onclick="action('transfer')">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="withdraw-screen" class="hidden">
        <h3>–°–Ω—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤</h3>
        <input type="number" id="w-sum" placeholder="–°—É–º–º–∞ —Å–Ω—è—Ç–∏—è">
        <button onclick="action('withdraw')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="bonds-screen" class="hidden">
        <h3>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å</h3>
        <div id="bonds-list" class="card"></div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="market-screen" class="hidden">
        <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏</h3>
        <div id="market-list"></div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const params = new URLSearchParams(window.location.search);

        function showPage(page) {
            document.getElementById('reg-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('transfer-screen').classList.add('hidden');
            document.getElementById('withdraw-screen').classList.add('hidden');
            document.getElementById('bonds-screen').classList.add('hidden');
            document.getElementById('market-screen').classList.add('hidden');
            
            const target = document.getElementById(page + '-screen');
            if(target) target.classList.remove('hidden');
        }

        function register() {
            const nick = document.getElementById('reg-nick').value;
            const role = document.getElementById('reg-role').value;
            if(!nick || !role) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
            tg.sendData(JSON.stringify({action: 'register', nick, role}));
        }

        function buyBond(id, minAmount) {
            const amount = parseFloat(prompt(`–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ (–º–∏–Ω–∏–º—É–º ${minAmount} GOLD):`, minAmount));
            if (isNaN(amount) || amount < minAmount) {
                alert(`–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: ${minAmount} GOLD`);
                return;
            }
            if(confirm(`–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å ${amount} GOLD?`)) {
                tg.sendData(JSON.stringify({
                    action: 'buy_bond', 
                    bond_id: parseInt(id),
                    amount: amount,
                    nick: decodeURIComponent(params.get('nick') || "User")
                }));
            }
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–Ω—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ–±–ª–∏–≥–∞—Ü–∏–∏
        function sellBond(id, val) {
            if(confirm(`–ó–∞–∫—Ä—ã—Ç—å –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—é –∏ –ø–æ–ª—É—á–∏—Ç—å ${val.toFixed(2)} GOLD –Ω–∞ –±–∞–ª–∞–Ω—Å?`)) {
                tg.sendData(JSON.stringify({
                    action: 'sell_bond',
                    bond_id: parseInt(id),
                    amount: parseFloat(val),
                    nick: decodeURIComponent(params.get('nick') || "User")
                }));
            }
        }

        function action(type) {
            const data = { action: type, nick: decodeURIComponent(params.get('nick') || "User") };
            if(type === 'transfer') {
                data.target_id = document.getElementById('t-id').value;
                data.amount = parseFloat(document.getElementById('t-sum').value);
                if (!data.target_id) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è!");
            } else {
                data.amount = parseFloat(document.getElementById('w-sum').value);
            }
            if (!data.amount || data.amount <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É!");
            tg.sendData(JSON.stringify(data));
        }

        window.onload = () => {
            const exists = params.get('exists') === 'true';
            document.getElementById('loader').classList.add('hidden');
            
            if (!exists) { 
                showPage('reg'); 
            } else {
                showPage('main');
                
                document.getElementById('u-nick').innerText = decodeURIComponent(params.get('nick') || "–ù–∏–∫");
                document.getElementById('u-role').innerText = decodeURIComponent(params.get('role') || "–î–æ–ª–∂–Ω–æ—Å—Ç—å");
                document.getElementById('u-bal').innerText = (params.get('bal') || "0.00") + " GOLD";
                document.getElementById('info-text').innerText = decodeURIComponent(params.get('info') || "–ù–æ–≤–æ—Å—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.");

                // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                try {
                    const users = JSON.parse(decodeURIComponent(params.get('users') || "[]"));
                    const currentId = params.get('tg_id');
                    const select = document.getElementById('t-id');
                    select.innerHTML = '<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω–∞</option>';
                    users.forEach(u => {
                        if (String(u.id) !== String(currentId)) {
                            const opt = document.createElement('option');
                            opt.value = u.id;
                            opt.text = u.nick;
                            select.appendChild(opt);
                        }
                    });
                } catch(e) { console.error("Users parse error"); }

                // –†–µ–Ω–¥–µ—Ä –ø–æ—Ä—Ç—Ñ–µ–ª—è (–û–ë–ù–û–í–õ–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ can_withdraw)
                try {
                    const bonds = JSON.parse(decodeURIComponent(params.get('bonds') || "[]"));
                    const list = document.getElementById('bonds-list');
                    list.innerHTML = bonds.length ? "" : "<small>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π.</small>";
                    bonds.forEach(b => {
                        // –ï—Å–ª–∏ can_withdraw == true, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É, –∏–Ω–∞—á–µ —Ç–µ–∫—Å—Ç –æ –∑–∞–º–æ—Ä–æ–∑–∫–µ
                        const actionHtml = b.can_withdraw 
                            ? `<button class="withdraw-btn" onclick="sellBond(${b.id}, ${b.current_value})">üí∞ –°–Ω—è—Ç—å ${b.current_value.toFixed(2)}</button>`
                            : `<span class="lock-badge">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ–º</span>`;

                        list.innerHTML += `
                            <div class="bond-item">
                                <b style="color: var(--gold)">${b.name}</b><br>
                                –í–ª–æ–∂–µ–Ω–æ: ${b.amount.toFixed(2)} GOLD<br>
                                –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å: <span style="color: #00ff00">+${b.current_value.toFixed(2)}</span><br>
                                <small>–°—Ç–∞–≤–∫–∞: ${b.rate}% | ${b.date}</small>
                                ${actionHtml}
                            </div>`;
                    });
                } catch(e) { console.error("Bonds parse error"); }

                // –†–µ–Ω–¥–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞
                try {
                    const market = JSON.parse(decodeURIComponent(params.get('market') || "[]"));
                    const mList = document.getElementById('market-list');
                    mList.innerHTML = market.length ? "" : "<div class='card'>–†—ã–Ω–æ–∫ –ø—É—Å—Ç.</div>";
                    market.forEach(m => {
                        mList.innerHTML += `
                            <div class="market-item">
                                <b style="color: var(--gold)">${m.name}</b><br>
                                –ú–∏–Ω. –≤–∫–ª–∞–¥: ${m.price} GOLD<br>
                                –î–æ—Ö–æ–¥: ${m.rate}% –≤ –¥–µ–Ω—å<br>
                                –ó–∞–º–æ—Ä–æ–∑–∫–∞: ${m.min_days} –¥–Ω.<br>
                                <button onclick="buyBond('${m.id}', ${m.price})">–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            </div>`;
                    });
                } catch(e) { console.error("Market parse error"); }
            }
        };
    </script>
</body>
</html>
