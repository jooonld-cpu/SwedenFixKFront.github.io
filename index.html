<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; padding: 15px; }
        .card { background: #2d2d2d; padding: 20px; border-radius: 15px; margin: 10px 0; border: 1px solid #ffd700; }
        button { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 8px; background: #ffd700; color: black; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }
        input, select { width: 95%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; background: #333; color: white; }
        .gold { color: #ffd700; font-size: 1.8em; font-weight: bold; margin: 10px 0; }
        label { display: block; text-align: left; margin: 10px 0 0 5px; color: #aaa; font-size: 0.9em; }
    </style>
</head>
<body>

    <div id="reg-screen" class="hidden">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –®–≤–µ—Ü–∏–∏</h2>
        <input type="text" id="nick" placeholder="–í–∞—à –ù–∏–∫">
        <input type="text" id="role" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å">
        <button onclick="register()">–í—Å—Ç—É–ø–∏—Ç—å –≤ –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ</button>
    </div>

    <div id="main-menu" class="hidden">
        <h2>–ö–∞–±–∏–Ω–µ—Ç –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω–∞</h2>
        <div class="card"><p id="user-info"></p></div>
        <button onclick="showFinance()">üè¶ –§–∏–Ω–∞–Ω—Å—ã (–°—á–µ—Ç–∞)</button>
        <button onclick="window.open('https://docs.google.com/document/d/1CtUNPBjuuo-twrqvRVmm0YhRizTwmP5xTh8G9xNwmzU/edit')">üìú –ó–∞–∫–æ–Ω—ã</button>
    </div>

    <div id="finance-screen" class="hidden">
        <h2>–í–∞—à–∏ –ë–∞–Ω–∫–∏</h2>
        <div class="card">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫:</label>
            <select id="bank-select" onchange="updateUI()"></select>
            <p>–ë–∞–ª–∞–Ω—Å:</p>
            <p class="gold"><span id="display-balance">0</span> GOLD</p>
        </div>
        <button onclick="showPage('transfer-page')">üí∏ –ü–µ—Ä–µ–≤–æ–¥</button>
        <button onclick="showPage('withdraw-page')">üì• –°–Ω—è—Ç–∏–µ</button>
        <button onclick="showPage('main-menu')" style="background:#555; color:white;">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="transfer-page" class="hidden">
        <h2>–ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h2>
        <select id="user-select"></select>
        <input type="number" id="t-amount" placeholder="–°—É–º–º–∞">
        <button onclick="send('transfer')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button onclick="showFinance()" style="background:#555; color:white;">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="withdraw-page" class="hidden">
        <h2>–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–Ω—è—Ç–∏–µ</h2>
        <input type="number" id="w-amount" placeholder="–°—É–º–º–∞">
        <button onclick="send('withdraw')">–ó–∞–ø—Ä–æ—Å–∏—Ç—å</button>
        <button onclick="showFinance()" style="background:#555; color:white;">–ù–∞–∑–∞–¥</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const params = new URLSearchParams(window.location.search);

        let accounts = [];
        try {
            accounts = JSON.parse(decodeURIComponent(params.get('accounts') || "[]"));
        } catch(e) { console.error(e); }

        if (params.get('exists') === 'true') {
            showPage('main-menu');
            document.getElementById('user-info').innerText = decodeURIComponent(params.get('nick')) + " [" + decodeURIComponent(params.get('role')) + "]";
            
            const bSel = document.getElementById('bank-select');
            accounts.forEach(a => {
                let o = document.createElement('option');
                o.value = a.bank_id; o.text = a.bank_name; o.dataset.bal = a.balance;
                bSel.appendChild(o);
            });

            const uSel = document.getElementById('user-select');
            decodeURIComponent(params.get('users') || "").split(',').forEach(u => {
                if(u.includes(':')) {
                    let [id, n] = u.split(':');
                    let o = document.createElement('option'); o.value = id; o.text = n;
                    uSel.appendChild(o);
                }
            });
        } else {
            showPage('reg-screen');
        }

        function updateUI() {
            const s = document.getElementById('bank-select');
            document.getElementById('display-balance').innerText = s.options[s.selectedIndex].dataset.bal;
        }

        function showFinance() { showPage('finance-screen'); updateUI(); }

        function showPage(id) {
            ['reg-screen', 'main-menu', 'finance-screen', 'transfer-page', 'withdraw-page'].forEach(p => document.getElementById(p).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function register() {
            const n = document.getElementById('nick').value;
            const r = document.getElementById('role').value;
            tg.sendData(JSON.stringify({ action: 'register', nick: n, role: r }));
        }

        function send(act) {
            const bid = document.getElementById('bank-select').value;
            const amt = parseFloat(document.getElementById(act === 'transfer' ? 't-amount' : 'w-amount').value);
            const target = document.getElementById('user-select').value;
            if(!amt || amt <= 0) return alert("–°—É–º–º–∞?");
            tg.sendData(JSON.stringify({ action: act, bank_id: parseInt(bid), amount: amt, target_id: target }));
            tg.close();
        }
    </script>
</body>
</html>
