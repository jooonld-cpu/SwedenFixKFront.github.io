<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweden Finance WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #ffd700; --bg: #1a1a1a; --card: #2d2d2d; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
               background: var(--bg); color: white; text-align: center; margin: 0; padding: 15px; }
        
        .card { background: var(--card); padding: 20px; border-radius: 15px; 
                margin: 15px 0; border: 1px solid rgba(255, 215, 0, 0.3); box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        button { width: 100%; padding: 14px; margin: 8px 0; border: none; border-radius: 10px; 
                 background: var(--gold); color: black; font-weight: bold; font-size: 16px; cursor: pointer; }
        button:active { transform: scale(0.98); opacity: 0.8; }
        
        .hidden { display: none; }
        
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; 
                        background: #333; color: white; box-sizing: border-box; font-size: 16px; }
        
        .gold-amount { color: var(--gold); font-size: 2.2em; font-weight: 800; margin: 10px 0; text-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
        .label { display: block; text-align: left; margin: 10px 0 0 5px; color: #aaa; font-size: 0.85em; text-transform: uppercase; }
        
        .user-badge { background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; font-size: 0.9em; display: inline-block; }
    </style>
</head>
<body>

    <div id="reg-screen" class="hidden">
        <h2 style="color: var(--gold);">üá∏üá™ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –®–≤–µ—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å:</p>
        <div class="card">
            <input type="text" id="nick" placeholder="–í–∞—à –∏–≥—Ä–æ–≤–æ–π –Ω–∏–∫">
            <input type="text" id="role" placeholder="–í–∞—à–∞ —Ä–æ–ª—å (–Ω–∞–ø—Ä. –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω)">
            <button onclick="register()">–í—Å—Ç—É–ø–∏—Ç—å –≤ —Ä–µ–µ—Å—Ç—Ä</button>
        </div>
    </div>

    <div id="main-menu" class="hidden">
        <h2 style="color: var(--gold);">–®–í–ï–¶–ò–Ø</h2>
        <div class="user-badge" id="user-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        
        <div class="card">
            <label class="label">–í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞:</label>
            <select id="bank-select" onchange="updateBalance()"></select>
            <p style="margin-bottom: 5px;">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:</p>
            <div class="gold-amount"><span id="display-balance">0</span> <span style="font-size: 0.5em;">GOLD</span></div>
        </div>

        <button onclick="showPage('transfer-page')">üí∏ –°–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
        <button onclick="showPage('withdraw-page')">üì• –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–Ω—è—Ç–∏–µ</button>
        <button onclick="window.open('https://docs.google.com/document/d/1CtUNPBjuuo-twrqvRVmm0YhRizTwmP5xTh8G9xNwmzU/edit')" style="background: #444; color: white;">üìú –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫/–ó–∞–∫–æ–Ω—ã</button>
    </div>

    <div id="transfer-page" class="hidden">
        <h2>–ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h2>
        <div class="card">
            <label class="label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</label>
            <select id="user-select"></select>
            <label class="label">–°—É–º–º–∞ (GOLD):</label>
            <input type="number" id="t-amount" placeholder="0.00">
            <button onclick="sendAction('transfer')">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
        </div>
        <button onclick="showPage('main-menu')" style="background:none; color: var(--gold);">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
    </div>

    <div id="withdraw-page" class="hidden">
        <h2>–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–ø–ª–∞—Ç—É</h2>
        <div class="card">
            <p>–í–∞—à –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–∞–∑–Ω–∞—á–µ—é (–∞–¥–º–∏–Ω—É) –Ω–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ.</p>
            <label class="label">–°—É–º–º–∞ –∫ —Å–Ω—è—Ç–∏—é:</label>
            <input type="number" id="w-amount" placeholder="0.00">
            <button onclick="sendAction('withdraw')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
        </div>
        <button onclick="showPage('main-menu')" style="background:none; color: var(--gold);">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const params = new URLSearchParams(window.location.search);
        let userAccounts = [];

        // 1. –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–•
        function init() {
            const exists = params.get('exists') === 'true';
            const nick = decodeURIComponent(params.get('nick') || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π");
            const role = decodeURIComponent(params.get('role') || "–ì–æ—Å—Ç—å");
            
            // –ü–∞—Ä—Å–∏–Ω–≥ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (–±–∞–ª–∞–Ω—Å–∞)
            try {
                const rawAccs = params.get('accounts');
                if (rawAccs) {
                    userAccounts = JSON.parse(decodeURIComponent(rawAccs));
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –±–∞–ª–∞–Ω—Å–∞:", e);
            }

            if (exists) {
                showPage('main-menu');
                document.getElementById('user-info').innerText = `${nick} ‚Ä¢ ${role}`;
                
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –±–∞–Ω–∫–æ–≤
                const bSel = document.getElementById('bank-select');
                bSel.innerHTML = "";
                userAccounts.forEach(acc => {
                    let opt = document.createElement('option');
                    opt.value = acc.bank_id;
                    opt.text = acc.bank_name;
                    opt.dataset.balance = acc.balance;
                    bSel.appendChild(opt);
                });

                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const uSel = document.getElementById('user-select');
                const rawUsers = decodeURIComponent(params.get('users') || "");
                uSel.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ --</option>';
                rawUsers.split(',').forEach(u => {
                    if(u.includes(':')) {
                        const [id, name] = u.split(':');
                        let opt = document.createElement('option');
                        opt.value = id; opt.text = name;
                        uSel.appendChild(opt);
                    }
                });

                updateBalance();
            } else {
                showPage('reg-screen');
            }
        }

        // 2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê
        function updateBalance() {
            const sel = document.getElementById('bank-select');
            if (sel.options[sel.selectedIndex]) {
                const bal = sel.options[sel.selectedIndex].dataset.balance;
                document.getElementById('display-balance').innerText = parseFloat(bal).toLocaleString();
            }
        }

        function showPage(id) {
            ['reg-screen', 'main-menu', 'transfer-page', 'withdraw-page'].forEach(p => {
                document.getElementById(p).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        // 3. –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –í –ë–û–¢–ê
        function register() {
            const n = document.getElementById('nick').value;
            const r = document.getElementById('role').value;
            if(!n) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫!");
            tg.sendData(JSON.stringify({ action: 'register', nick: n, role: r }));
        }

        function sendAction(act) {
            const bankId = document.getElementById('bank-select').value;
            const amount = parseFloat(document.getElementById(act === 'transfer' ? 't-amount' : 'w-amount').value);
            const target = document.getElementById('user-select').value;

            if(!amount || amount <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É");
            if(act === 'transfer' && !target) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è");

            tg.sendData(JSON.stringify({
                action: act,
                bank_id: parseInt(bankId),
                amount: amount,
                target_id: target,
                nick: decodeURIComponent(params.get('nick') || "")
            }));
            tg.close();
        }

        init();
    </script>
</body>
</html>
