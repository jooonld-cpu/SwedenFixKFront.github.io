<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweden Finance</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #ffd700; --bg: #1a1a1a; --card: #2d2d2d; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--gold); }
        .info-bar { background: #b8860b33; padding: 12px; font-size: 13px; border-radius: 8px; margin-bottom: 20px; color: var(--gold); text-align: center; border: 1px solid var(--gold); }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; background: var(--gold); border: none; border-radius: 8px; font-weight: bold; font-size: 16px; color: #000; cursor: pointer; margin-top: 5px; }
        .hidden { display: none !important; }
        .bond-item { border-bottom: 1px solid #444; padding: 10px 0; }
        .nav-btn { background: #333; color: white; margin-top: 10px; }
        .market-item { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
        .withdraw-btn { background: #28a745; color: white; margin-top: 10px; font-size: 14px; padding: 10px; }
        .lock-badge { font-size: 11px; color: #ff4444; margin-top: 8px; display: block; }
    </style>
</head>
<body>
    <div id="loader" style="text-align: center; padding-top: 50px;">‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–µ–µ—Å—Ç—Ä—É...</div>

    <div id="reg-screen" class="hidden">
        <h2 style="color: var(--gold)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <input type="text" id="reg-nick" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º">
        <input type="text" id="reg-role" placeholder="–í–∞—à–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç—å">
        <button onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </div>

    <div id="main-screen" class="hidden">
        <div class="info-bar" id="info-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div style="margin-bottom: 20px;">
            <h2 id="u-nick" style="margin:0; color: var(--gold)">–ù–∏–∫–Ω–µ–π–º</h2>
            <div id="u-role" style="opacity: 0.7; font-size: 14px;">–î–æ–ª–∂–Ω–æ—Å—Ç—å</div>
        </div>
        <div class="card">
            <small>–ë–ê–õ–ê–ù–°</small>
            <h1 id="u-bal">0.00 GOLD</h1>
        </div>
        <h3>–û–ø–µ—Ä–∞—Ü–∏–∏</h3>
        <button onclick="showPage('transfer')">üí∏ –ü–µ—Ä–µ–≤–æ–¥ –∏–≥—Ä–æ–∫—É</button>
        <button onclick="showPage('withdraw')">üè¶ –°–Ω—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤</button>
        <button onclick="showPage('bonds')" style="background: #daa520">üìà –ú–æ–∏ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</button>
        <button onclick="showPage('market')" style="background: #0055aa; color: white;">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
        <button onclick="window.open('https://t.me/SwedenFix_News', '_blank')" style="background: #444; color: white; border: 1px solid var(--gold);">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</button>
        
        <button onclick="tg.close()" class="nav-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="transfer-screen" class="hidden">
        <h3>–ü–µ—Ä–µ–≤–æ–¥ GOLD</h3>
        <select id="t-id"></select>
        <input type="number" id="t-sum" placeholder="–°—É–º–º–∞">
        <button onclick="action('transfer')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="withdraw-screen" class="hidden">
        <h3>–°–Ω—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤</h3>
        <input type="number" id="w-sum" placeholder="–°—É–º–º–∞">
        <button onclick="action('withdraw')">–ó–∞–ø—Ä–æ—Å–∏—Ç—å</button>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="bonds-screen" class="hidden">
        <h3>–í–∞—à–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h3>
        <div id="bonds-list"></div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="market-screen" class="hidden">
        <h3>–ú–∞–≥–∞–∑–∏–Ω –æ–±–ª–∏–≥–∞—Ü–∏–π</h3>
        <div id="market-list"></div>
        <button onclick="showPage('main')" class="nav-btn">–ù–∞–∑–∞–¥</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const params = new URLSearchParams(window.location.search);

        function showPage(page) {
            ['reg', 'main', 'transfer', 'withdraw', 'bonds', 'market'].forEach(p => {
                const el = document.getElementById(p + '-screen');
                if (el) el.classList.add('hidden');
            });
            document.getElementById(page + '-screen').classList.remove('hidden');
        }

        function register() {
            const nick = document.getElementById('reg-nick').value;
            const role = document.getElementById('reg-role').value;
            if(!nick || !role) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");
            tg.sendData(JSON.stringify({action: 'register', nick, role}));
        }

        function action(type) {
            const data = { action: type, nick: decodeURIComponent(params.get('nick') || "User") };
            if(type === 'transfer') {
                data.target_id = document.getElementById('t-id').value;
                data.amount = parseFloat(document.getElementById('t-sum').value);
            } else {
                data.amount = parseFloat(document.getElementById('w-sum').value);
            }
            if(!data.amount || data.amount <= 0) return alert("–û—à–∏–±–∫–∞ —Å—É–º–º—ã!");
            tg.sendData(JSON.stringify(data));
        }

        function buyBond(id, minPrice) {
            const amount = parseFloat(prompt(`–°—É–º–º–∞ (–º–∏–Ω ${minPrice}):`, minPrice));
            if(amount >= minPrice) {
                tg.sendData(JSON.stringify({action: 'buy_bond', bond_id: parseInt(id), amount: amount}));
            }
        }

        function sellBond(id, val) {
            if(confirm(`–ó–∞–±—Ä–∞—Ç—å ${val.toFixed(2)} GOLD?`)) {
                tg.sendData(JSON.stringify({action: 'sell_bond', bond_id: parseInt(id)}));
            }
        }

        window.onload = () => {
            document.getElementById('loader').classList.add('hidden');
            const exists = params.get('exists') === 'true';
            
            if (!exists) {
                showPage('reg');
            } else {
                showPage('main');
                document.getElementById('u-nick').innerText = decodeURIComponent(params.get('nick') || "User");
                document.getElementById('u-role').innerText = decodeURIComponent(params.get('role') || "");
                document.getElementById('u-bal').innerText = (params.get('bal') || "0.00") + " GOLD";
                document.getElementById('info-text').innerText = decodeURIComponent(params.get('info') || "–ù–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç");

                // –Æ–∑–µ—Ä—ã
                try {
                    const users = JSON.parse(decodeURIComponent(params.get('users') || "[]"));
                    const sel = document.getElementById('t-id');
                    sel.innerHTML = '<option value="" disabled selected>–ö–æ–º—É –ø–µ—Ä–µ–≤–æ–¥–∏–º?</option>';
                    users.forEach(u => {
                        if(u.id !== params.get('tg_id')) {
                            sel.innerHTML += `<option value="${u.id}">${u.nick}</option>`;
                        }
                    });
                } catch(e) {}

                // –û–±–ª–∏–≥–∞—Ü–∏–∏
                try {
                    const bonds = JSON.parse(decodeURIComponent(params.get('bonds') || "[]"));
                    const bList = document.getElementById('bonds-list');
                    bList.innerHTML = bonds.length ? "" : "–ù–µ—Ç –≤–ª–æ–∂–µ–Ω–∏–π";
                    bonds.forEach(b => {
                        const btn = b.can_withdraw 
                            ? `<button class="withdraw-btn" onclick="sellBond(${b.id}, ${b.current_value})">üí∞ –°–Ω—è—Ç—å ${b.current_value.toFixed(2)}</button>`
                            : `<span class="lock-badge">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</span>`;
                        bList.innerHTML += `<div class="card"><b>${b.name}</b><br>–ù–∞ —Å—á–µ—Ç—É: ${b.current_value.toFixed(2)} GOLD<br>${btn}</div>`;
                    });
                } catch(e) {}

                // –ú–∞–≥–∞–∑–∏–Ω
                try {
                    const market = JSON.parse(decodeURIComponent(params.get('market') || "[]"));
                    const mList = document.getElementById('market-list');
                    mList.innerHTML = "";
                    market.forEach(m => {
                        mList.innerHTML += `<div class="market-item"><b>${m.name}</b> (${m.rate}%)<br>–ú–∏–Ω: ${m.price}<br><button onclick="buyBond(${m.id}, ${m.price})">–ö—É–ø–∏—Ç—å</button></div>`;
                    });
                } catch(e) {}
            }
        };
    </script>
</body>
</html>
