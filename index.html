<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweden Finance</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #ffd700; --bg: #1a1a1a; --card: #2d2d2d; --text: #eeeeee; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid var(--gold); }
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .menu-btn { height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--card); border: 1px solid #444; border-radius: 12px; color: var(--gold); font-weight: bold; cursor: pointer; text-align: center; }
        button { width: 100%; padding: 14px; margin: 8px 0; border: none; border-radius: 10px; background: var(--gold); color: black; font-weight: bold; cursor: pointer; }
        .btn-sec { background: #444; color: white; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; background: #333; color: white; border: 1px solid #444; box-sizing: border-box; }
        .hidden { display: none; }
        #loader { text-align: center; margin-top: 50px; color: var(--gold); font-size: 1.2em; }
    </style>
</head>
<body>

<div id="loader">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã...</div>

<div id="main-menu" class="hidden">
    <div style="text-align: center; margin-bottom: 20px;">
        <h2 id="u-nick">–ù–∏–∫</h2>
        <div id="u-role" style="opacity: 0.6;">–†–æ–ª—å</div>
    </div>
    <div class="grid-menu">
        <div class="menu-btn" onclick="showPage('page-finance')">üí∞<br>–°—á–µ—Ç–∞</div>
        <div class="menu-btn" onclick="showPage('page-bonds')">üìà<br>–ë—É–º–∞–≥–∏</div>
        <div class="menu-btn" onclick="showPage('page-apps')">üìù<br>–ü–æ–º–æ—â—å</div>
        <div class="menu-btn" onclick="window.open('https://docs.google.com/document/d/1CtUNPBjuuo-twrqvRVmm0YhRizTwmP5xTh8G9xNwmzU/edit')">üìú<br>–ó–∞–∫–æ–Ω—ã</div>
    </div>
</div>

<div id="page-finance" class="hidden">
    <h3>–ö–æ—à–µ–ª–µ–∫</h3>
    <div class="card">
        <select id="bank-select" onchange="updateBal()"></select>
        <h2 id="bal-val">0.00 GOLD</h2>
    </div>
    <button onclick="showPage('page-transfer')">üí∏ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∏–≥—Ä–æ–∫—É</button>
    <button onclick="showPage('page-withdraw')">üèß –°–Ω—è—Ç—å –Ω–∞–ª–∏—á–Ω—ã–µ</button>
    <button class="btn-sec" onclick="showPage('main-menu')">–ù–∞–∑–∞–¥</button>
</div>

<div id="page-bonds" class="hidden">
    <h3>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h3>
    <div id="bonds-list"></div>
    <hr>
    <h4>–ö—É–ø–∏—Ç—å –Ω–æ–≤—É—é</h4>
    <select id="b-type">
        <option value="–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –û–±–ª–∏–≥–∞—Ü–∏—è">–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è (1.5%)</option>
        <option value="–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è –û–±–ª–∏–≥–∞—Ü–∏—è">–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è (1.0%)</option>
    </select>
    <input type="number" id="b-amount" placeholder="–°—É–º–º–∞">
    <button onclick="sendBond()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    <button class="btn-sec" onclick="showPage('main-menu')">–ù–∞–∑–∞–¥</button>
</div>

<div id="page-apps" class="hidden">
    <h3>–ñ–∞–ª–æ–±—ã –∏ –æ—à–∏–±–∫–∏</h3>
    <textarea id="bug-text" rows="5" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É..."></textarea>
    <button onclick="sendBug()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω—É</button>
    <button class="btn-sec" onclick="showPage('main-menu')">–ù–∞–∑–∞–¥</button>
</div>

<div id="page-transfer" class="hidden">
    <h3>–ü–µ—Ä–µ–≤–æ–¥ –∏–≥—Ä–æ–∫—É</h3>
    <select id="u-select"></select>
    <input type="number" id="t-amount" placeholder="–°—É–º–º–∞">
    <button onclick="doTransfer()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–æ–ª–æ—Ç–æ</button>
    <button class="btn-sec" onclick="showPage('page-finance')">–ù–∞–∑–∞–¥</button>
</div>

<div id="page-withdraw" class="hidden">
    <h3>–°–Ω—è—Ç–∏–µ –∑–æ–ª–æ—Ç–∞</h3>
    <input type="number" id="w-amount" placeholder="–°—É–º–º–∞ –∫ —Å–Ω—è—Ç–∏—é">
    <button onclick="sendWithdraw()">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–¥–∞—á—É</button>
    <button class="btn-sec" onclick="showPage('page-finance')">–ù–∞–∑–∞–¥</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    let params = new URLSearchParams(window.location.search);

    function sendAction(action, data) {
        tg.sendData(JSON.stringify({action: action, ...data}));
    }

    function load() {
        try {
            // –ù–∏–∫ –∏ –†–æ–ª—å
            document.getElementById('u-nick').innerText = decodeURIComponent(params.get('nick') || "–ñ–∏—Ç–µ–ª—å");
            document.getElementById('u-role').innerText = decodeURIComponent(params.get('role') || "–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω");

            // –°—á–µ—Ç–∞
            const accsRaw = params.get('accounts');
            const bSel = document.getElementById('bank-select');
            if (accsRaw) {
                const accs = JSON.parse(decodeURIComponent(accsRaw));
                bSel.innerHTML = "";
                accs.forEach(a => {
                    let o = new Option(`${a.bank_name}`, a.bank_id);
                    o.dataset.bal = a.balance;
                    bSel.add(o);
                });
            }

            // –û–±–ª–∏–≥–∞—Ü–∏–∏
            const bondsRaw = params.get('bonds');
            const bList = document.getElementById('bonds-list');
            if (bondsRaw) {
                const bonds = JSON.parse(decodeURIComponent(bondsRaw));
                bList.innerHTML = bonds.length ? "" : "<p style='opacity:0.5'>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ü–µ–Ω–Ω—ã—Ö –±—É–º–∞–≥</p>";
                bonds.forEach(b => {
                    bList.innerHTML += `<div class="card" style="border-left:4px solid #00ff00">
                        <b>${b.name}</b><br>
                        <small>–í–∑–Ω–æ—Å: ${b.amount.toFixed(2)}</small><br>
                        <span>üí∞ –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: ${b.current_value.toFixed(2)}</span>
                    </div>`;
                });
            }

            // –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ (–ó–∞—â–∏—â–µ–Ω–Ω—ã–π —Å–ø–ª–∏—Ç)
            const usersRaw = params.get('users');
            const uSel = document.getElementById('u-select');
            if (usersRaw) {
                uSel.innerHTML = "";
                const users = decodeURIComponent(usersRaw).split(',');
                users.forEach(u => {
                    if (u.includes(':')) {
                        const [id, name] = u.split(':');
                        uSel.add(new Option(name, id));
                    }
                });
            }

            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('loader').classList.add('hidden');
            showPage('main-menu');
            updateBal();

        } catch (e) {
            console.error(e);
            document.getElementById('loader').innerText = "‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω—É.";
        }
    }

    function updateBal() {
        const s = document.getElementById('bank-select');
        if (s && s.options.length > 0) {
            const bal = parseFloat(s.options[s.selectedIndex].dataset.bal || 0);
            document.getElementById('bal-val').innerText = bal.toFixed(2) + " GOLD";
        }
    }

    function showPage(id) {
        const pages = ['main-menu','page-finance','page-bonds','page-apps','page-transfer','page-withdraw'];
        pages.forEach(p => {
            const el = document.getElementById(p);
            if (el) el.classList.add('hidden');
        });
        const target = document.getElementById(id);
        if (target) target.classList.remove('hidden');
    }

    function doTransfer() {
        const amt = parseFloat(document.getElementById('t-amount').value);
        const target = document.getElementById('u-select').value;
        if (!amt || !target) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
        sendAction('transfer', { amount: amt, target_id: target });
    }

    function sendWithdraw() {
        const amt = parseFloat(document.getElementById('w-amount').value);
        if (!amt) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
        sendAction('bug_report', { message: `–ó–ê–ü–†–û–° –í–´–í–û–î–ê: ${amt} GOLD` });
    }

    function sendBond() {
        const amt = parseFloat(document.getElementById('b-amount').value);
        const type = document.getElementById('b-type').value;
        if (!amt) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
        sendAction('bond_request', { bond_name: type, amount: amt });
    }

    function sendBug() {
        const msg = document.getElementById('bug-text').value;
        if (!msg) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç");
        sendAction('bug_report', { message: msg });
    }

    load();
</script>
</body>
</html>
