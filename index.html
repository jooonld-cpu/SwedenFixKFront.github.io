<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweden Finance</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; padding: 20px; }
        .card { background: #2d2d2d; padding: 20px; border-radius: 15px; margin: 15px 0; border: 1px solid #ffd700; }
        button { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px; background: #ffd700; color: black; font-weight: bold; cursor: pointer; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; background: #333; color: white; border: 1px solid #444; box-sizing: border-box; }
        .balance { color: #ffd700; font-size: 2em; font-weight: bold; margin: 10px 0; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="reg-screen" class="hidden">
        <h2>üá∏üá™ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <input type="text" id="nick" placeholder="–ò–≥—Ä–æ–≤–æ–π –Ω–∏–∫">
        <input type="text" id="role" placeholder="–†–æ–ª—å">
        <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    </div>

    <div id="main-menu" class="hidden">
        <h2 id="user-display">–®–≤–µ—Ü–∏—è</h2>
        <div class="card">
            <select id="bank-select" onchange="updateUI()"></select>
            <div class="balance"><span id="bal-val">0</span> GOLD</div>
        </div>
        <button onclick="showPage('transfer-page')">üí∏ –ü–µ—Ä–µ–≤–æ–¥</button>
        <button onclick="showPage('withdraw-page')">üì§ –°–Ω—è—Ç–∏–µ</button>
    </div>

    <div id="transfer-page" class="hidden">
        <h2>–ü–µ—Ä–µ–≤–æ–¥</h2>
        <select id="user-select"></select>
        <input type="number" id="t-amount" placeholder="–°—É–º–º–∞">
        <button onclick="doAction('transfer')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button onclick="showPage('main-menu')" style="background:#444; color:white;">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="withdraw-page" class="hidden">
        <h2>–ó–∞–ø—Ä–æ—Å —Å–Ω—è—Ç–∏—è</h2>
        <input type="number" id="w-amount" placeholder="–°—É–º–º–∞">
        <button onclick="doAction('withdraw')">–ó–∞–ø—Ä–æ—Å–∏—Ç—å</button>
        <button onclick="showPage('main-menu')" style="background:#444; color:white;">–ù–∞–∑–∞–¥</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const params = new URLSearchParams(window.location.search);
        let accounts = [];

        function init() {
            const exists = params.get('exists') === 'true';
            if (!exists) return showPage('reg-screen');

            const nick = decodeURIComponent(params.get('nick') || "");
            document.getElementById('user-display').innerText = nick;

            try {
                accounts = JSON.parse(decodeURIComponent(params.get('accounts') || "[]"));
                const bSel = document.getElementById('bank-select');
                accounts.forEach(a => {
                    let opt = new Option(a.bank_name, a.bank_id);
                    opt.dataset.bal = a.balance;
                    bSel.add(opt);
                });
            } catch(e) {}

            const uSel = document.getElementById('user-select');
            const users = decodeURIComponent(params.get('users') || "").split(',');
            users.forEach(u => {
                if(u.includes(':')) {
                    const [id, name] = u.split(':');
                    uSel.add(new Option(name, id));
                }
            });

            showPage('main-menu');
            updateUI();
        }

        function updateUI() {
            const sel = document.getElementById('bank-select');
            const bal = sel.options[sel.selectedIndex]?.dataset.bal || 0;
            document.getElementById('bal-val').innerText = parseFloat(bal).toLocaleString();
        }

        function showPage(id) {
            ['reg-screen', 'main-menu', 'transfer-page', 'withdraw-page'].forEach(p => document.getElementById(p).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function register() {
            const nick = document.getElementById('nick').value;
            const role = document.getElementById('role').value;
            tg.sendData(JSON.stringify({action: 'register', nick, role}));
        }

        function doAction(type) {
            const amount = parseFloat(document.getElementById(type === 'transfer' ? 't-amount' : 'w-amount').value);
            const bank_id = parseInt(document.getElementById('bank-select').value);
            const target = document.getElementById('user-select').value;
            const nick = decodeURIComponent(params.get('nick') || "");

            if(!amount || amount <= 0) return alert("–°—É–º–º–∞?");
            tg.sendData(JSON.stringify({action: type, amount, bank_id, target_id: target, nick}));
            tg.close();
        }

        init();
    </script>
</body>
</html>
