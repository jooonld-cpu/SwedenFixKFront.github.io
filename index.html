<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweden Finance System</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #ffd700; --bg: #1a1a1a; --card: #2d2d2d; --text: #eeeeee; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; overflow-x: hidden; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid var(--gold); }
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .menu-btn { height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--card); border: 1px solid #444; border-radius: 12px; color: var(--gold); font-weight: bold; cursor: pointer; text-align: center; }
        .menu-btn:active { transform: scale(0.95); background: #3d3d3d; }
        button { width: 100%; padding: 14px; margin: 8px 0; border: none; border-radius: 10px; background: var(--gold); color: black; font-weight: bold; font-size: 16px; cursor: pointer; }
        button:active { opacity: 0.8; }
        .btn-sec { background: #444; color: white; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; background: #333; color: white; border: 1px solid #444; box-sizing: border-box; font-size: 16px; }
        .hidden { display: none; }
        .header { text-align: center; margin-bottom: 20px; }
        .bond-item { background: #333; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-bottom: 2px solid var(--gold); }
        #loader { text-align: center; padding-top: 50px; color: var(--gold); font-weight: bold; }
    </style>
</head>
<body>

<div id="loader">‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–∏—Å—Ç–µ–º–µ...</div>

<div id="register-page" class="hidden">
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <div class="card">
        <input type="text" id="reg-nick" placeholder="–ò–≥—Ä–æ–≤–æ–π –Ω–∏–∫">
        <select id="reg-role">
            <option value="–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω">–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω</option>
            <option value="–ú–∏–Ω–∏—Å—Ç—Ä">–ú–∏–Ω–∏—Å—Ç—Ä</option>
            <option value="–ë–∏–∑–Ω–µ—Å–º–µ–Ω">–ë–∏–∑–Ω–µ—Å–º–µ–Ω</option>
        </select>
        <button onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </div>
</div>

<div id="main-menu" class="hidden">
    <div class="header">
        <h2 id="u-nick">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <div id="u-role" style="opacity: 0.6; font-size: 0.9em;">–†–æ–ª—å</div>
    </div>
    <div class="grid-menu">
        <div class="menu-btn" onclick="showPage('page-finance')">üí∞<br>–§–∏–Ω–∞–Ω—Å—ã</div>
        <div class="menu-btn" onclick="showPage('page-apps')">üìù<br>–ó–∞—è–≤–ª–µ–Ω–∏—è</div>
        <div class="menu-btn" onclick="showPage('page-bonds')">üìà<br>–¶–µ–Ω–Ω—ã–µ –±—É–º–∞–≥–∏</div>
        <div class="menu-btn" onclick="window.open('https://docs.google.com/document/d/1CtUNPBjuuo-twrqvRVmm0YhRizTwmP5xTh8G9xNwmzU/edit')">üìú<br>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</div>
    </div>
</div>

<div id="page-finance" class="hidden">
    <h3>–ú–æ–∏ —Å—á–µ—Ç–∞</h3>
    <div class="card">
        <select id="bank-select" onchange="updateBal()"></select>
        <h2 id="bal-val">0.00 GOLD</h2>
    </div>
    <button onclick="showPage('page-transfer')">üí∏ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
    <button onclick="showPage('page-withdraw')">üèß –°–Ω—è—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞</button>
    <button class="btn-sec" onclick="showPage('main-menu')">–ù–∞–∑–∞–¥</button>
</div>

<div id="page-withdraw" class="hidden">
    <h3>–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–Ω—è—Ç–∏–µ</h3>
    <div class="card">
        <p style="font-size: 0.8em; opacity: 0.7;">–ó–æ–ª–æ—Ç–æ –±—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–æ —Å–æ —Å—á–µ—Ç–∞ –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</p>
        <input type="number" id="w-amount" placeholder="–°—É–º–º–∞ –¥–ª—è —Å–Ω—è—Ç–∏—è">
        <button onclick="sendWithdraw()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
    </div>
    <button class="btn-sec" onclick="showPage('page-finance')">–ù–∞–∑–∞–¥</button>
</div>

<div id="page-bonds" class="hidden">
    <h3>–¶–µ–Ω–Ω—ã–µ –±—É–º–∞–≥–∏</h3>
    <button onclick="showPage('sub-my-bonds')">üìÇ –ú–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å</button>
    <button onclick="showPage('sub-buy-bond')">üõí –ö—É–ø–∏—Ç—å –æ–±–ª–∏–≥–∞—Ü–∏—é</button>
    <button class="btn-sec" onclick="showPage('main-menu')">–ù–∞–∑–∞–¥</button>
</div>

<div id="sub-my-bonds" class="hidden">
    <h3>–í–∞—à –ø–æ—Ä—Ç—Ñ–µ–ª—å</h3>
    <div id="bonds-list"></div>
    <button class="btn-sec" onclick="showPage('page-bonds')">–ù–∞–∑–∞–¥</button>
</div>

<div id="sub-buy-bond" class="hidden">
    <h3>–ü–æ–∫—É–ø–∫–∞ –æ–±–ª–∏–≥–∞—Ü–∏–∏</h3>
    <div class="card">
        <select id="b-type">
            <option value="–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –û–±–ª–∏–≥–∞—Ü–∏—è">–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è (1.5%)</option>
            <option value="–ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–∞—è –û–±–ª–∏–≥–∞—Ü–∏—è">–ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–∞—è (0.7%)</option>
        </select>
        <input type="number" id="b-amount" placeholder="–°—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏">
        <button onclick="sendBond()">–ö—É–ø–∏—Ç—å</button>
    </div>
    <button class="btn-sec" onclick="showPage('page-bonds')">–ù–∞–∑–∞–¥</button>
</div>

<div id="page-apps" class="hidden">
    <h3>–ó–∞—è–≤–ª–µ–Ω–∏—è</h3>
    <button onclick="showPage('sub-bug')">üö´ –û—à–∏–±–∫–∏ —Å–∏—Å—Ç–µ–º—ã</button>
    <button class="btn-sec" onclick="showPage('main-menu')">–ù–∞–∑–∞–¥</button>
</div>

<div id="sub-bug" class="hidden">
    <h3>–ñ–∞–ª–æ–±–∞ –ö–æ—Ä–æ–ª—é</h3>
    <div class="card">
        <textarea id="bug-text" maxlength="500" rows="5" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ..."></textarea>
        <button onclick="sendBug()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <button class="btn-sec" onclick="showPage('page-apps')">–ù–∞–∑–∞–¥</button>
</div>

<div id="page-transfer" class="hidden">
    <h3>–ü–µ—Ä–µ–≤–æ–¥ –∏–≥—Ä–æ–∫—É</h3>
    <div class="card">
        <select id="u-select"></select>
        <input type="number" id="t-amount" placeholder="–°—É–º–º–∞">
        <button onclick="doTransfer()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–æ–ª–æ—Ç–æ</button>
    </div>
    <button class="btn-sec" onclick="showPage('page-finance')">–ù–∞–∑–∞–¥</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    let params = new URLSearchParams(window.location.search);

    function load() {
        try {
            if (params.get('exists') !== "true") {
                showPage('register-page');
            } else {
                document.getElementById('u-nick').innerText = decodeURIComponent(params.get('nick') || "–ñ–∏—Ç–µ–ª—å");
                document.getElementById('u-role').innerText = decodeURIComponent(params.get('role') || "–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω");
                
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–Ω–∫–æ–≤
                const accs = JSON.parse(decodeURIComponent(params.get('accounts') || "[]"));
                const bSel = document.getElementById('bank-select');
                bSel.innerHTML = "";
                accs.forEach(a => {
                    let o = new Option(a.bank_name, a.bank_id);
                    o.dataset.bal = a.balance;
                    bSel.add(o);
                });

                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±–ª–∏–≥–∞—Ü–∏–π
                const bonds = JSON.parse(decodeURIComponent(params.get('bonds') || "[]"));
                const bList = document.getElementById('bonds-list');
                bList.innerHTML = bonds.length ? "" : "<p style='opacity:0.5; text-align:center;'>–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—É–º–∞–≥</p>";
                bonds.forEach(b => {
                    bList.innerHTML += `<div class="bond-item"><b>${b.name}</b><br>${b.amount.toFixed(2)} GOLD<br><small>–í—ã–¥–∞–Ω–∞: ${b.date}</small></div>`;
                });

                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —é–∑–µ—Ä–æ–≤
                const usersStr = decodeURIComponent(params.get('users') || "");
                const uSel = document.getElementById('u-select');
                uSel.innerHTML = "<option value=''>-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ --</option>";
                if (usersStr) {
                    usersStr.split(',').forEach(u => { 
                        if(u.includes(':')) uSel.add(new Option(u.split(':')[1], u.split(':')[0])); 
                    });
                }

                showPage('main-menu');
                updateBal();
            }
        } catch (e) {
            console.error("Load Error:", e);
            alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞.");
        }
        document.getElementById('loader').classList.add('hidden');
    }

    function updateBal() {
        const s = document.getElementById('bank-select');
        if (s.selectedIndex === -1) return;
        const bal = parseFloat(s.options[s.selectedIndex].dataset.bal || 0);
        document.getElementById('bal-val').innerText = bal.toLocaleString(undefined, {minimumFractionDigits: 2}) + " GOLD";
    }

    function showPage(id) {
        const pages = ['register-page','main-menu','page-finance','page-bonds','sub-my-bonds','sub-buy-bond','page-apps','sub-bug','page-transfer','page-withdraw'];
        pages.forEach(p => {
            const el = document.getElementById(p);
            if(el) el.classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
    }

    function register() {
        const nick = document.getElementById('reg-nick').value;
        const role = document.getElementById('reg-role').value;
        if(!nick) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫!");
        tg.sendData(JSON.stringify({ action: 'register', nick: nick, role: role }));
        tg.close();
    }

    function doTransfer() {
        const amount = parseFloat(document.getElementById('t-amount').value);
        const target = document.getElementById('u-select').value;
        const bank = parseInt(document.getElementById('bank-select').value);
        if(!amount || !target) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
        
        tg.sendData(JSON.stringify({ 
            action: 'transfer', 
            amount: amount, 
            target_id: target, 
            bank_id: bank,
            nick: params.get('nick')
        }));
        tg.close();
    }

    function sendWithdraw() {
        const amount = parseFloat(document.getElementById('w-amount').value);
        if(!amount || amount <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!");
        
        tg.sendData(JSON.stringify({
            action: 'withdraw_request',
            amount: amount,
            bank_id: parseInt(document.getElementById('bank-select').value),
            nick: params.get('nick')
        }));
        tg.close();
    }

    function sendBond() {
        const amount = parseFloat(document.getElementById('b-amount').value);
        const type = document.getElementById('b-type').value;
        if(!amount || amount <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–∫—É–ø–∫–∏!");
        
        tg.sendData(JSON.stringify({ 
            action: 'bond_request', 
            bond_name: type, 
            amount: amount, 
            bank_id: parseInt(document.getElementById('bank-select').value), 
            nick: params.get('nick') 
        }));
        tg.close();
    }

    function sendBug() {
        const txt = document.getElementById('bug-text').value;
        if(!txt || txt.length < 5) return alert("–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ!");
        tg.sendData(JSON.stringify({ 
            action: 'bug_report', 
            message: txt, 
            nick: params.get('nick') 
        }));
        tg.close();
    }

    window.onload = load;
</script>
</body>
</html>
