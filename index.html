package main

import (
	"database/sql"
	"encoding/json"
	"fmt"
	"log"
	"math"
	"net/url"
	"os"
	"strconv"
	"strings"
	"time"

	_ "github.com/lib/pq"
	"gopkg.in/telebot.v3"
)

const AdminID = 7631664265
const WebAppURL = "https://jooonld-cpu.github.io/SwedenFixKFront.github.io/"

var userState = make(map[int64]string)
var tempReg = make(map[int64]map[string]string)

type Bond struct {
	ID           int     `json:"id"`
	Name         string  `json:"name"`
	Amount       float64 `json:"amount"`
	Rate         float64 `json:"rate"`
	CurrentValue float64 `json:"current_value"`
	Date         string  `json:"date"`
}

type WebAppData struct {
	Action   string  `json:"action"`
	TargetID string  `json:"target_id"`
	Amount   float64 `json:"amount"`
	BondName string  `json:"bond_name"`
	Message  string  `json:"message"`
}

func main() {
	db, err := sql.Open("postgres", os.Getenv("DATABASE_URL"))
	if err != nil {
		log.Fatal(err)
	}

	b, err := telebot.NewBot(telebot.Settings{
		Token:  os.Getenv("BOT_TOKEN"),
		Poller: &telebot.LongPoller{Timeout: 10 * time.Second},
	})
	if err != nil {
		log.Fatal(err)
	}

	db.Exec(`CREATE TABLE IF NOT EXISTS users (tg_id TEXT PRIMARY KEY, nickname TEXT, role TEXT, balance FLOAT DEFAULT 0)`)
	db.Exec(`CREATE TABLE IF NOT EXISTS bonds (id SERIAL PRIMARY KEY, user_id TEXT, name TEXT, amount FLOAT, rate FLOAT, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)`)
	db.Exec(`CREATE TABLE IF NOT EXISTS reports (id SERIAL PRIMARY KEY, user_id TEXT, text TEXT, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)`)

	calcBond := func(amount, rate float64, t time.Time) float64 {
		days := math.Floor(time.Since(t).Hours() / 24)
		if days < 0 { days = 0 }
		return amount * math.Pow(1+(rate/100), days)
	}

	b.Handle("/start", func(c telebot.Context) error {
		uid := strconv.FormatInt(c.Sender().ID, 10)
		var exists bool
		db.QueryRow("SELECT EXISTS(SELECT 1 FROM users WHERE tg_id=$1)", uid).Scan(&exists)
		if !exists {
			userState[c.Sender().ID] = "reg_nick"
			return c.Send("ðŸ‡¸ðŸ‡ª Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ ÐÐ¸Ðº:")
		}
		return sendMenu(c, db, calcBond)
	})

	b.Handle(telebot.OnText, func(c telebot.Context) error {
		state, ok := userState[c.Sender().ID]
		if !ok { return nil }
		uid := strconv.FormatInt(c.Sender().ID, 10)
		if state == "reg_nick" {
			tempReg[c.Sender().ID] = map[string]string{"nick": c.Text()}
			userState[c.Sender().ID] = "reg_role"
			return c.Send("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ÑÑ‚ÑŒ:")
		} else if state == "reg_role" {
			db.Exec("INSERT INTO users (tg_id, nickname, role, balance) VALUES ($1, $2, $3, 0)", uid, tempReg[c.Sender().ID]["nick"], c.Text())
			delete(userState, c.Sender().ID)
			return sendMenu(c, db, calcBond)
		}
		return nil
	})

	b.Handle(telebot.OnWebApp, func(c telebot.Context) error {
		var data WebAppData
		if err := json.Unmarshal([]byte(c.Message().WebAppData.Data), &data); err != nil {
			return nil
		}
		uid := strconv.FormatInt(c.Sender().ID, 10)
		if data.Action == "transfer" {
			tx, _ := db.Begin()
			var bal float64
			tx.QueryRow("SELECT balance FROM users WHERE tg_id=$1", uid).Scan(&bal)
			if bal < data.Amount {
				tx.Rollback()
				return c.Send("âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÑ€ÐµÐ´ÑÑ‚Ð²")
			}
			tx.Exec("UPDATE users SET balance = balance - $1 WHERE tg_id = $2", data.Amount, uid)
			tx.Exec("UPDATE users SET balance = balance + $1 WHERE tg_id = $2", data.Amount, data.TargetID)
			tx.Commit()
			return c.Send("âœ… ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½")
		}
		return nil
	})

	b.Start()
}

func sendMenu(c telebot.Context, db *sql.DB, calc func(float64, float64, time.Time) float64) error {
	uid := strconv.FormatInt(c.Sender().ID, 10)
	var nick, role string
	var balance float64
	db.QueryRow("SELECT nickname, role, balance FROM users WHERE tg_id=$1", uid).Scan(&nick, &role, &balance)

	rows, _ := db.Query("SELECT tg_id, nickname FROM users")
	var uList []string
	for rows.Next() {
		var id, n string
		rows.Scan(&id, &n)
		uList = append(uList, id+":"+n)
	}
	rows.Close()

	accs, _ := json.Marshal([]map[string]interface{}{{"bank_id": 1, "bank_name": "ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹", "balance": balance}})
	
	bondRows, _ := db.Query(`SELECT id, name, amount, rate, created_at FROM bonds WHERE user_id = $1`, uid)
	var bonds []Bond
	for bondRows.Next() {
		var bo Bond
		var t time.Time
		bondRows.Scan(&bo.ID, &bo.Name, &bo.Amount, &bo.Rate, &t)
		bo.CurrentValue = calc(bo.Amount, bo.Rate, t)
		bo.Date = t.Format("02.01.2006")
		bonds = append(bonds, bo)
	}
	bondRows.Close()
	bJ, _ := json.Marshal(bonds)

	v := url.Values{}
	v.Set("nick", nick)
	v.Set("role", role)
	v.Set("accounts", string(accs))
	v.Set("bonds", string(bJ))
	v.Set("users", strings.Join(uList, ","))
	
	menu := &telebot.ReplyMarkup{ResizeKeyboard: true}
	menu.Reply(menu.Row(menu.WebApp("ðŸ‡¸ðŸ‡ª ÐšÐ°Ð±Ð¸Ð½ÐµÑ‚", &telebot.WebApp{URL: WebAppURL + "?" + v.Encode()})))
	return c.Send("ðŸ‡¸ðŸ‡ª ÐœÐµÐ½ÑŽ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾", menu)
}
